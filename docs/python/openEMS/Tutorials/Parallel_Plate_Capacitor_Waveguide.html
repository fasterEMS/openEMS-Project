<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallel-Plate Capacitor and Waveguide &mdash; openEMS 0.0.35 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Introductional Tutorials" href="Intro_Tutorials.html" />
    <link rel="prev" title="Start from the Basics" href="First_Lessons_Forewords.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> openEMS
          </a>
              <div class="version">
                0.0.35
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/index.html">Install</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="First_Lessons.html">First Lessons For Circuit Designers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="First_Lessons_Forewords.html">Start from the Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="First_Lessons_Forewords.html#workflow-of-fdtd">Workflow of FDTD</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Parallel-Plate Capacitor and Waveguide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#this-tutorial-covers">This tutorial covers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#problem">Problem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-conductors">Create Conductors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements-for-the-mesh">Requirements for the Mesh</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#general-requirements">General Requirements</a></li>
<li class="toctree-l5"><a class="reference internal" href="#courant-friedrichs-lewy-cfl-criterion">Courant-Friedrichs-Lewy (CFL) Criterion</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-mesh">Create a Mesh</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#obtain-the-mesh-object">Obtain the Mesh Object</a></li>
<li class="toctree-l5"><a class="reference internal" href="#decide-the-upper-frequency-and-mesh-resolution">Decide the Upper Frequency and Mesh Resolution</a></li>
<li class="toctree-l5"><a class="reference internal" href="#a-simple-but-flawed-mesh">A Simple But Flawed Mesh</a></li>
<li class="toctree-l5"><a class="reference internal" href="#a-practical-mesh">A Practical Mesh</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#optional-create-a-field-dump-box">Optional: Create A Field Dump Box</a></li>
<li class="toctree-l4"><a class="reference internal" href="#purpose-of-ports">Purpose of Ports</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#test-fixture-as-1-port-or-2-port-network">Test Fixture as 1-Port or 2-Port Network</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#create-ports">Create Ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-excitation">Create Excitation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#specify-the-boundary-conditions">Specify the Boundary Conditions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#reflecting-dirichlet-boundary-conditions">Reflecting (Dirichlet) Boundary Conditions</a></li>
<li class="toctree-l5"><a class="reference internal" href="#absorbing-boundary-conditions-abc">Absorbing Boundary Conditions (ABC)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#set-boundary-conditions">Set Boundary Conditions</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#start-simulation">Start Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-checkpoint-1">Code Checkpoint 1</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#our-existing-code-so-far">Our Existing Code So Far</a></li>
<li class="toctree-l5"><a class="reference internal" href="#code-refactoring">Code Refactoring</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#run-simulation">Run Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#built-in-post-processing">Built-In Post-Processing</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#port-attribute-references">Port Attribute References</a></li>
<li class="toctree-l5"><a class="reference internal" href="#introduction-to-s-parameters">Introduction to S-parameters</a></li>
<li class="toctree-l5"><a class="reference internal" href="#calculate-s-parameters">Calculate S-parameters</a></li>
<li class="toctree-l5"><a class="reference internal" href="#plot-s-parameters-via-matplotlib">Plot S-parameters via matplotlib</a></li>
<li class="toctree-l5"><a class="reference internal" href="#plot-z-parameters-impedances-via-matplotlib">Plot Z-parameters (Impedances) via matplotlib</a></li>
<li class="toctree-l5"><a class="reference internal" href="#code-checkpoint-2-eliminate-repetitions-in-matplotlib-code">Code Checkpoint 2: Eliminate Repetitions in <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> Code</a></li>
<li class="toctree-l5"><a class="reference internal" href="#plot-time-domain-waveforms-via-matplotlib">Plot Time-Domain Waveforms via matplotlib</a></li>
<li class="toctree-l5"><a class="reference internal" href="#export-s-parameters-to-touchstone">Export S-parameters to Touchstone</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#s2p-file"><code class="docutils literal notranslate"><span class="pre">.s2p</span></code> file</a></li>
<li class="toctree-l6"><a class="reference internal" href="#s1p-file"><code class="docutils literal notranslate"><span class="pre">.s1p</span></code> file</a></li>
<li class="toctree-l6"><a class="reference internal" href="#snp-file"><code class="docutils literal notranslate"><span class="pre">.snp</span></code> file</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#code-checkpoint-3">Code Checkpoint 3</a></li>
<li class="toctree-l4"><a class="reference internal" href="#third-party-post-processing">Third-Party Post-Processing</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#s-parameters-analysis-via-scikit-rf">S-parameters Analysis via <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code></a><ul>
<li class="toctree-l6"><a class="reference internal" href="#install-and-import">Install and Import</a></li>
<li class="toctree-l6"><a class="reference internal" href="#plot-smith-charts">Plot Smith Charts</a></li>
<li class="toctree-l6"><a class="reference internal" href="#plot-magnitude-phase-charts">Plot Magnitude-Phase Charts</a></li>
<li class="toctree-l6"><a class="reference internal" href="#plot-impedance-chart">Plot Impedance Chart</a></li>
<li class="toctree-l6"><a class="reference internal" href="#time-domain-reflectometry">Time Domain Reflectometry</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#transient-analysis-via-signalintegrity">Transient Analysis via <code class="docutils literal notranslate"><span class="pre">SignalIntegrity</span></code></a><ul>
<li class="toctree-l6"><a class="reference internal" href="#install">Install</a></li>
<li class="toctree-l6"><a class="reference internal" href="#impulse-signal-analysis">Impulse Signal Analysis</a></li>
<li class="toctree-l6"><a class="reference internal" href="#eye-diagram-analysis">Eye Diagram Analysis</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#s-parameters-analysis-via-qucs">S-Parameters Analysis via Qucs</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#id9">Install</a></li>
<li class="toctree-l6"><a class="reference internal" href="#enable-qucsator">Enable Qucsator</a></li>
<li class="toctree-l6"><a class="reference internal" href="#s-parameter-simulation-skeleton">S-Parameter Simulation Skeleton</a></li>
<li class="toctree-l6"><a class="reference internal" href="#two-port-s-parameter-analysis">Two-Port S-Parameter Analysis</a></li>
<li class="toctree-l6"><a class="reference internal" href="#comparison-with-microstrip">Comparison with Microstrip</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#field-dumps-analysis-via-paraview">Field Dumps Analysis via ParaView</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#experimental-validation-and-discussion">Experimental Validation and Discussion</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#motivation">Motivation</a></li>
<li class="toctree-l5"><a class="reference internal" href="#experiment">Experiment</a></li>
<li class="toctree-l5"><a class="reference internal" href="#results">Results</a></li>
<li class="toctree-l5"><a class="reference internal" href="#impedance-transformation">Impedance Transformation</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshoot">Troubleshoot</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#notes-for-wayland-users">Notes for Wayland Users</a></li>
<li class="toctree-l5"><a class="reference internal" href="#warning-unused-primitive-type-box-detected-in-property-plate">Warning: Unused primitive (type: Box) detected in property: plate!</a></li>
<li class="toctree-l5"><a class="reference internal" href="#warning-unused-primitive-type-box-detected-in-property-port-excite-1">Warning: Unused primitive (type: Box) detected in property: port_excite_1!</a></li>
<li class="toctree-l5"><a class="reference internal" href="#calcvoltageintegral-error-only-a-1d-line-integration-is-allowed">CalcVoltageIntegral: Error, only a 1D/line integration is allowed</a></li>
<li class="toctree-l5"><a class="reference internal" href="#no-qucsator-in-qucs-s">No <span class="guilabel">Qucsator</span> in Qucs-S</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#programmatic-solution">Programmatic Solution</a></li>
<li class="toctree-l6"><a class="reference internal" href="#gui-solution">GUI Solution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#bibliography">Bibliography</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Intro_Tutorials.html">Introductional Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="MicroWave_Tutorials.html">Micro Wave Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="Antenna_Tutorials.html">Antennas</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../python.html">Python Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../octave/octave.html">Octave/Matlab Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../more.html">Learn More</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">openEMS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Tutorials</a> &raquo;</li>
          <li><a href="First_Lessons.html">First Lessons For Circuit Designers</a> &raquo;</li>
      <li>Parallel-Plate Capacitor and Waveguide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/python/openEMS/Tutorials/Parallel_Plate_Capacitor_Waveguide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="parallel-plate-capacitor-and-waveguide">
<h1>Parallel-Plate Capacitor and Waveguide<a class="headerlink" href="#parallel-plate-capacitor-and-waveguide" title="Permalink to this headline"></a></h1>
<section id="this-tutorial-covers">
<h2>This tutorial covers<a class="headerlink" href="#this-tutorial-covers" title="Permalink to this headline"></a></h2>
<ul>
<li><p><strong>Model</strong>: Learn how to set up the components of a basic 3D FDTD model, including:</p>
<blockquote>
<div><ul class="simple">
<li><p>Create conductors in the simulation box.</p></li>
<li><p>Create a Cartesian mesh (Yee’s cells) and correctly apply the 1/3-2/3 rule to
ensure accuracy.</p></li>
<li><p>Add an excitation port with signal.</p></li>
<li><p>Inspect the finished 3D model with AppCSXCAD.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Boundary Conditions</strong>: Understand the available boundary conditions in openEMS and
their physical interpretation.</p></li>
<li><p><strong>Simulate</strong>: Run simulation to obtain the S-parameters (frequency response) of
the waveguide.</p></li>
<li><p><strong>Built-in Post-Processing</strong>: Calculate the final frequency response (S-parameters)
and time-domain signal waveforms.</p>
<blockquote>
<div><ul class="simple">
<li><p>Plot S-parameters, Z-parameters, time-domain waveforms via matplotlib.</p></li>
<li><p>Save the raw electromagnetic field dump.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Third-Party Post-Processing</strong>: Know the common tools for data analysis.</p>
<blockquote>
<div><ul class="simple">
<li><p>Understand that S-parameters are the parameters that characterize a linear
circuit’s frequency response as a blackbox without knowledge of the underlying
physics. The physics is open to interpretation.</p></li>
<li><p>Plot S-parameters on Smith, line charts, and calculate Time-Domain Reflectometry
via <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code>.</p></li>
<li><p>Simulate the waveguide’s time-domain response and eye diagrams via the Python
package <code class="docutils literal notranslate"><span class="pre">SignalIntegrity</span></code></p></li>
<li><p>Plot the S-parameters using Qucs, compare our results with an ideal microstrip
transmission line, and with experimental data.</p></li>
<li><p>Visualize electromagnetic fields using ParaView.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Coding Standard</strong>: Refactor the simulation code with good programming practice
in mind, by keeping 3D modeling, simulation, and post-processing as separate
functions. This ensures that different simulations can be ran with different
parameters in the future.</p></li>
</ul>
</section>
<section id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline"></a></h2>
<p>A rectangular parallel-plate capacitor in a vacuum is a staple in
physics classes, but the physics involved is far more complex than an ideal
capacitor in introductory books. In the RF/microwave regime, the signal’s
wavelength is comparable or smaller than the physical size of the capacitor,
the plates form a two-conductor transmission line, known as a <em>parallel-plate
waveguide</em>. A real waveguide with a finite size also complicates the
problem due to fringe field, neglected in most theoretical treatments. The
large plate separation makes the problem even harder due to radiation loss
and multimoding. It’s easy for the signal to escape from the structures.
acting as an antenna. Moreover, this structure supports both the familiar
TEM-mode waves in two-conductor transmission lines such as ordinary cables,
and the TE/TM-mode waves in an enclosed one-conductor waveguide.</p>
<p>By numerically solving Maxwell’s equations from scratch, a 3D full-wave
field solver like openEMS is the most practical way to predict its behavior.</p>
<p>Our task is to find the frequency response of this rectangular parallel-plate
waveguide. The plates are 100 mm x 100 mm rectangular metal plates with
negligible resistance, negligible thickness, and separated by 16 mm of
vacuum.</p>
<p>The 2D cross-section of the 3D waveguide is the following:</p>
<img alt="../../../_images/capacitor1.py.svg" src="../../../_images/capacitor1.py.svg" /></section>
<section id="create-conductors">
<h2>Create Conductors<a class="headerlink" href="#create-conductors" title="Permalink to this headline"></a></h2>
<p>An openEMS simulation always starts by creating a 3D model of the Device-Under-Test
(DUT) using the CSXCAD library. We import the library in Python, and create an empty
structure called <code class="docutils literal notranslate"><span class="pre">csx</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">CSXCAD</span>

<span class="n">csx</span> <span class="o">=</span> <span class="n">CSXCAD</span><span class="o">.</span><span class="n">ContinuousStructure</span><span class="p">()</span>
</pre></div>
</div>
<p>The next step is to create an instance of material to build an object. Since we’re
modeling metal plates with negligible resistance, we use the CSXCAD function
<a class="reference internal" href="../../CSXCAD/CSXCAD.html#CSXCAD.ContinuousStructure.AddMetal" title="CSXCAD.ContinuousStructure.AddMetal"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AddMetal()</span></code></a> to obtain an instance of a Perfect
Electric Conductor (PEC):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an instance of material named &quot;plate&quot;.</span>
<span class="c1"># AddMetal() creates a Perfect Electric Conductor.</span>
<span class="n">metal</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">AddMetal</span><span class="p">(</span><span class="s1">&#39;plate&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Internally, PEC is implemented by forcing the tangential electric field in this
region be zero, which is the behavior of an ideal conductor that can’t be penetrated
by electric field lines. If resistive losses are unimportant, one can use PEC
rather than a realistic material model for simplicity and efficiency.</p>
<p>To add a general material (defined by a permittivity, permeability, electric
conductivity, magnetic conductivity) such as dielectrics, use
<a class="reference internal" href="../../CSXCAD/CSXCAD.html#CSXCAD.ContinuousStructure.AddMaterial" title="CSXCAD.ContinuousStructure.AddMaterial"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AddMaterial()</span></code></a>. In principle, it works for
3D metals as well. But thin metal sheets are challenging for FDTD, to capture
effects like surface current (skin effect) requires an impractically high
resolution mesh. Thus, it’s recommended to use
<a class="reference internal" href="../../CSXCAD/CSXCAD.html#CSXCAD.ContinuousStructure.AddConductingSheet" title="CSXCAD.ContinuousStructure.AddConductingSheet"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AddConductingSheet()</span></code></a> which mimicks the
resistive loss in metals using a simplified model that still treats metals
as zero-thickness 2D planes, modeling the observed loss rather than the full
physics.</p>
</div>
<p>In the next step, we build a box using our material “metal”, using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">AddBox()</span></code> function. It accepts two 3D
coordinates to specify the region occupied by the box.</p>
<p>Our waveguide plates are 100 mm x 100 mm rectangular metal sheets, separated by a
16 mm vacuum (i.e. empty space). Following the convention of CAD, we center
the plates around the origin. Thus, for the upper plate, both its X and Y
coordinates are (-50, 50). Their Z coordinates are -8 and 8 respectively, which
means these metal plates have no thickness:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build two 3D shapes from -50 to 50 on the X/Y axes, located at Z = -8</span>
<span class="c1"># and Z = 8 respectively. Note that the starting and stopping Z coordinates</span>
<span class="c1"># of each plate are the same, resulting in metal plates with zero thickness.</span>
<span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># lower plate</span>
<span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">])</span>  <span class="c1"># upper plate</span>
</pre></div>
</div>
<p>Now it’s a good time to take a look at the structure that we’ve just created
by saving the CSXCAD structure as a file. It’s best to keep a call to
<a class="reference internal" href="../../CSXCAD/CSXCAD.html#CSXCAD.ContinuousStructure.Write2XML" title="CSXCAD.ContinuousStructure.Write2XML"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Write2XML()</span></code></a> always at the bottom of a script
during development, so the model can be inspected at any time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="c1"># find the directory of the script itself</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="c1"># create a directory named after the script, but without &quot;.py&quot;</span>
<span class="n">simdir</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">simdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># find the filename of the script itself, and replace &quot;.py&quot; with &quot;.xml&quot;</span>
<span class="n">xmlname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># concat path</span>
<span class="n">xmlpath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">xmlname</span>

<span class="n">csx</span><span class="o">.</span><span class="n">Write2XML</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xmlpath</span><span class="p">))</span>  <span class="c1"># convert Path object to string</span>
</pre></div>
</div>
<p>Once saved by executing our Python script, one can open the file via AppCSXCAD
to visualize the model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ AppCSXCAD Parallel_Plate_Capacitor_Waveguide.xml
</pre></div>
</div>
<p>One can inspect the 3D model by dragging its 3D view with a mouse.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you’re using Wayland, AppCSXCAD may not work correctly, see <a class="reference internal" href="#wayland"><span class="std std-ref">Notes for Wayland Users</span></a>.</p>
</div>
<p>Here’s the XY and YZ cross-sections of the correct 3D model:</p>
<a class="reference internal image-reference" href="../../../_images/capacitor_xy_nomesh.png"><img alt="../../../_images/capacitor_xy_nomesh.png" src="../../../_images/capacitor_xy_nomesh.png" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="../../../_images/capacitor_yz_nomesh.png"><img alt="../../../_images/capacitor_yz_nomesh.png" src="../../../_images/capacitor_yz_nomesh.png" style="width: 49%;" /></a>
</section>
<section id="requirements-for-the-mesh">
<h2>Requirements for the Mesh<a class="headerlink" href="#requirements-for-the-mesh" title="Permalink to this headline"></a></h2>
<p>At this point, the 3D object itself is materialized. In the next step, we
create a mesh to partition the continuous 3D box into discrete rectangular
cuboids. In the Finite-Difference Time-Domain (FDTD) algorithm, these
cuboids discretize the 3D space and form the basic unit of electromagnetic
calculations. They’re known as Yee’s cells (named after Kane S. Yee’s 1966
algorithm).</p>
<section id="general-requirements">
<h3>General Requirements<a class="headerlink" href="#general-requirements" title="Permalink to this headline"></a></h3>
<p>In general, the mesh must satisfy three requirements:</p>
<ol class="arabic simple">
<li><p>Its interval must be small enough to resolve the shortest wavelength (highest
frequency component) of the signal, so that electromagnetic field details are
not missed. Thus, we need several cells per wavelength.</p></li>
<li><p>Its interval must be small enough to resolve the shapes of the simulated
structure (especially small details), so that the details of the structure
are not missed. Thus, we need at least a few cells around the important
shapes (such as the waveguide plates) of the structure.</p></li>
<li><p>Its interval should not change suddenly by a large factor.</p></li>
</ol>
<p>As a rule of thumb, we want a mesh resolution of at least:</p>
<div class="math notranslate nohighlight">
\[l_\mathrm{cell} \le \dfrac{1}{10} \lambda\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the same “1/10 wavelength” rule of thumb used for
determining whether transmission line effects are significant in a
distributed circuit.</p>
</div>
<p>The relationship between wavelength and frequency is:</p>
<div class="math notranslate nohighlight">
\[\lambda = \frac{v}{f_\mathrm{max}}\]</div>
<p>in which <span class="math notranslate nohighlight">\(\lambda\)</span> is the wavelength of the electromagnetic wave
in meters, <span class="math notranslate nohighlight">\(v\)</span> is the speed of light in a medium, in meters per second,
and <span class="math notranslate nohighlight">\(f_\mathrm{max}\)</span> is the highest frequency component of the signals
used in simulation.</p>
<p>The speed of light in a medium is given by:</p>
<div class="math notranslate nohighlight">
\[v \approx \frac{c_0}{\sqrt{\epsilon_r\mue_r}}\]</div>
<p>in which <span class="math notranslate nohighlight">\(c_0\)</span> is the speed of light in vacuum, <span class="math notranslate nohighlight">\(\epsilon_r\)</span>
is the relative permittivity of the medium (in engineering, it’s sometimes
also denoted as a material’s dielectric constant <span class="math notranslate nohighlight">\(D_k = \epsilon_r\)</span>).
In vacuum, <span class="math notranslate nohighlight">\(\epsilon_r = 1\)</span> and <span class="math notranslate nohighlight">\(\mue_r = 1\)</span> exactly. The
<span class="math notranslate nohighlight">\(\mue_r\)</span> term is usually omitted in engineering since most insulators
(like plastics or fiberglass) is non-magnetic.</p>
</section>
<section id="courant-friedrichs-lewy-cfl-criterion">
<h3>Courant-Friedrichs-Lewy (CFL) Criterion<a class="headerlink" href="#courant-friedrichs-lewy-cfl-criterion" title="Permalink to this headline"></a></h3>
<p>In general, the CFL criterion governs the stability of FDTD
calculations. It states that the simulation timestep can’t be
larger than:</p>
<div class="math notranslate nohighlight">
\[\Delta t \le
\frac{1}{v\sqrt{
{1 \over {\Delta x^2}} + {1 \over {\Delta y^2}} + {1 \over {\Delta z^2}}
}}\]</div>
<p>in which <span class="math notranslate nohighlight">\(v\)</span> is the wave speed, <span class="math notranslate nohighlight">\(\Delta x\)</span>,
<span class="math notranslate nohighlight">\(\Delta y\)</span>, <span class="math notranslate nohighlight">\(\Delta z\)</span> are the distances between mesh
lines.</p>
<p>This creates a peculiar limitation: the simulation timestep must
both be small enough to resolve the shortest wavelength, and to
resolve the smallest mesh cell.</p>
<p>Even for simulations at low frequencies, as long as the simulated
structure has small features (i.e. mesh distance is short), we
must use very small timesteps, iterating simulation box several
nanoseconds at a time. Below the shortwave band under 30 MHz, the
number of iterations grows to an impractical number. This means
openEMS (and other textbook FDTD solvers) are unsuitable if
there’s a large mismatch between the signal wavelength and the
physical size of the structure, such as a 10 cm circuit board at
1 MHz (300 m in vacuum).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In openEMS, just ensure the mesh itself is correct. There’s
no need to calculate the required timestep size, as it
automatically calculates simulation timesteps
using a modified criterion named <em>Rennings2</em>, not CFL
(derived
in the unpublished paper <a class="footnote-reference brackets" href="#id23" id="id1">11</a>, see
<a class="reference internal" href="../openEMS.html#openEMS.openEMS.SetTimeStepMethod" title="openEMS.openEMS.SetTimeStepMethod"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SetTimeStepMethod()</span></code></a>).
But the general limitation still applies.</p>
<p>If you really need small cells
(e.g. to resolve some important feature of your structure) you
will have to live with long execution times, or perhaps FDTD is
not the right method for your problem. As a workaround, one may
also try extracting the circuit parameters using a higher signal
frequency, general linear circuit simulators can subsequently
simulate this equivalent circuit at low frequencies.</p>
</div>
</section>
</section>
<section id="create-a-mesh">
<h2>Create a Mesh<a class="headerlink" href="#create-a-mesh" title="Permalink to this headline"></a></h2>
<section id="obtain-the-mesh-object">
<h3>Obtain the Mesh Object<a class="headerlink" href="#obtain-the-mesh-object" title="Permalink to this headline"></a></h3>
<p>We obtain the <code class="docutils literal notranslate"><span class="pre">mesh</span></code> object by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">GetGrid()</span></code>
to manipulate it further, and set its unit of measurements to 1 mm (<code class="docutils literal notranslate"><span class="pre">1e-3</span></code>
meters):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mesh</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">GetGrid</span><span class="p">()</span>
<span class="n">unit</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SetDeltaUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="decide-the-upper-frequency-and-mesh-resolution">
<h3>Decide the Upper Frequency and Mesh Resolution<a class="headerlink" href="#decide-the-upper-frequency-and-mesh-resolution" title="Permalink to this headline"></a></h3>
<p>Let’s pick an arbitrary upper frequency of 10 GHz. Based on the previous
analysis, one can calculate the desired mesh resolution via the following
code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">openEMS.physical_constants</span> <span class="kn">import</span> <span class="n">C0</span>

<span class="n">f_max</span> <span class="o">=</span> <span class="mf">10e9</span>
<span class="n">epsilon_r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon_r</span><span class="p">)</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">f_max</span> <span class="o">/</span> <span class="n">unit</span>  <span class="c1"># convert to millimeters</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="mi">10</span>
</pre></div>
</div>
</section>
<section id="a-simple-but-flawed-mesh">
<h3>A Simple But Flawed Mesh<a class="headerlink" href="#a-simple-but-flawed-mesh" title="Permalink to this headline"></a></h3>
<p>Now, the most straightforward way of meshing the model is to draw some lines
between (-50, 50) on the X and Y axis, and some lines from (-8, 8) on the Z axis.
This is best done by drawing two lines at the beginning and end of each axis,
using the <code class="xref py py-meth docutils literal notranslate"><span class="pre">AddLine()</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>  <span class="c1"># two lines at -50, 50</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>  <span class="c1"># two lines at -50, 50</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>    <span class="c1"># two lines at -8, 8</span>
</pre></div>
</div>
<p>Once we have two lines per axis, one can ask CSXCAD to automatically smooth
the mesh based on all existing lines via
<code class="xref py py-meth docutils literal notranslate"><span class="pre">SmoothMeshLines()</span></code>. Its second argument
is the minimum spacing between the lines, here we let it to be <code class="docutils literal notranslate"><span class="pre">res</span></code>. This is the
desired mesh resolution we’ve just calculated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<p>Now it’s a good time to rerun the script and inspect the 3D model again in AppCSXCAD.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You possibly can’t see the mesh lines in AppCSXCAD, as they’re made invisible due to
their overlaps with the object. If it happens, it’s necessary to view the model from
an angle or a different direction (e.g. if there are no mesh lines when viewed from
the top, try dragging the model to view it from with a slight angle). It’s also useful
to change the “Grid opacity” slider to the maximum (but it still requires viewing from
an angle).</p>
<img alt="../../../_images/appcsxcad-opacity-slider.png" src="../../../_images/appcsxcad-opacity-slider.png" />
</div>
<p>Our 3D model’s XY and YZ cross-sections are:</p>
<a class="reference internal image-reference" href="../../../_images/capacitor_xy_naivemesh.png"><img alt="../../../_images/capacitor_xy_naivemesh.png" src="../../../_images/capacitor_xy_naivemesh.png" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="../../../_images/capacitor_yz_naivemesh.png"><img alt="../../../_images/capacitor_yz_naivemesh.png" src="../../../_images/capacitor_yz_naivemesh.png" style="width: 49%;" /></a>
</section>
<section id="a-practical-mesh">
<h3>A Practical Mesh<a class="headerlink" href="#a-practical-mesh" title="Permalink to this headline"></a></h3>
<p>Unfortunately, using the mesh as shown in a simulation will produce
incorrect results due to several problems.</p>
<p>The simulation box is as large as the waveguide, there’s no empty
space around the waveguide in the simulation box, so the electric
field around the waveguide is not modeled correctly. There are
legitimate use cases for this model, such as when modeling an
infinite-length waveguide (with Absorbing Boundary Conditions),
or a capacitor stuck in a metal box (with Perfect Electric Conductor
boundary conditions). But here, we are modeling a finite waveguide
with realistic behaviors, including fringe fields and radiation.</p>
<p>As a quick fix to the problem, one can make the simulation box several
times as big in volume in comparison to the waveguide, giving plenty of
room for the simulation to breathe. We delete the original three
<code class="xref py py-meth docutils literal notranslate"><span class="pre">AddLine()</span></code> calls and replace them with
the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># delete these lines</span>
<span class="c1"># mesh.AddLine(&#39;x&#39;, [-50, 50])  # two lines at -50, 50</span>
<span class="c1"># mesh.AddLine(&#39;y&#39;, [-50, 50])  # two lines at -50, 50</span>
<span class="c1"># mesh.AddLine(&#39;z&#39;, [-8, 8])    # two lines at -8, 8</span>
<span class="c1"># mesh.SmoothMeshLines(&#39;x&#39;, res)</span>
<span class="c1"># mesh.SmoothMeshLines(&#39;y&#39;, res)</span>
<span class="c1"># mesh.SmoothMeshLines(&#39;z&#39;, res)</span>

<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span>   <span class="mi">50</span><span class="p">])</span>  <span class="c1"># two lines at -50, 50</span>
</pre></div>
</div>
<p>Another problem is that the mesh is perfectly aligned with the edges
of the waveguide plates. In simulations, the edge of a structure creates
singularities with strong electric fields, creating significant errors
that can’t be removed even when tiny cells are used.</p>
<p>To mitigate this fundamental error source of FDTD, the mesh should
be intentionally misaligned with the metal edge. For the best results,
we introduce additional cells with different sizes around the edge,
creating an overall rectilinear mesh of non-uniform size. Around the
metal edge, the metal occupies 1/3 of a cell, while the vacuum or
insulator occupies 2/3 of a cell. This is known as the <strong>1/3-2/3 rule</strong>.</p>
<p>Let’s apply the rule to the X and Y axis:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># strategically draw lines misaligned with the waveguide&#39;s left and right edges,</span>
<span class="c1"># so that the edge occupies 33% space within a cell.</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the X axis</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the Y axis</span>
</pre></div>
</div>
<p>Another thing to note is that zero-thickness objects like the metal
plates must align to an exact mesh lines, otherwise these objects can’t
be simulated. Thus, we create two mesh lines on the Z axis at the exact
level of the plates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zero-thickness metal plates need mesh lines at their exact levels</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Zero-thickness metal plates need mesh lines at their exact levels</p>
</div>
<p>Finally we resmooth the mesh:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s inspect the model again, it’s now much better.</p>
<a class="reference internal image-reference" href="../../../_images/capacitor_xy_bettermesh.png"><img alt="../../../_images/capacitor_xy_bettermesh.png" src="../../../_images/capacitor_xy_bettermesh.png" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="../../../_images/capacitor_yz_bettermesh.png"><img alt="../../../_images/capacitor_yz_bettermesh.png" src="../../../_images/capacitor_yz_bettermesh.png" style="width: 49%;" /></a>
</section>
</section>
<section id="optional-create-a-field-dump-box">
<span id="fielddump"></span><h2>Optional: Create A Field Dump Box<a class="headerlink" href="#optional-create-a-field-dump-box" title="Permalink to this headline"></a></h2>
<p>Some applications make use of the raw electromagnetic fields, not just the
input and output signals. We can do this by creating a dump box to save raw
fields samples to disk. For troubleshooting malfunctioning simulations, this
is quite helpful as one can identify the problematic region directly by
visualization.</p>
<p>Several kinds of dump boxes exist.</p>
<ol class="arabic simple">
<li><p>Time-domain dumps of electric field <span class="math notranslate nohighlight">\(\mathbf{E}\)</span>, auxiliary magnetic
field <span class="math notranslate nohighlight">\(\mathbf{H}\)</span>, electric conduction current <span class="math notranslate nohighlight">\(\mathbf{J}\)</span>,
total current density <span class="math notranslate nohighlight">\(\mathrm{\nabla} \times \mathbf{H}\)</span>, electric
displacement field <span class="math notranslate nohighlight">\(\mathbf{D}\)</span>, and magnetic field (flux density)
<span class="math notranslate nohighlight">\(\mathbf{B}\)</span>, numbered from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">5</span></code>.</p></li>
<li><p>Frequency-domain dumps of electric field, auxiliary magnetic field,
electric conduction current, total current density, electric displacement
field, and magnetic field (flux density), numbered from <code class="docutils literal notranslate"><span class="pre">10</span></code> to <code class="docutils literal notranslate"><span class="pre">15</span></code>.</p></li>
<li><p>Specific Absorption Rate (SAR) for E&amp;M radiation exposure analysis.</p></li>
<li><p>Near-Field to Far-Field Transformation (NF2FF) for antenna analysis
(special, must use <a class="reference internal" href="../openEMS.html#openEMS.openEMS.CreateNF2FFBox" title="openEMS.openEMS.CreateNF2FFBox"><code class="xref py py-meth docutils literal notranslate"><span class="pre">openEMS.openEMS.CreateNF2FFBox()</span></code></a>).</p></li>
</ol>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>For usage, see <a class="reference internal" href="../../CSXCAD/CSXCAD.html#CSXCAD.ContinuousStructure.AddDump" title="CSXCAD.ContinuousStructure.AddDump"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CSXCAD.ContinuousStructure.AddDump()</span></code></a>. For a detailed
list of parameters, see <a class="reference internal" href="../../CSXCAD/CSProperties/CSPropDumpBox.html#CSXCAD.CSProperties.CSPropDumpBox" title="CSXCAD.CSProperties.CSPropDumpBox"><code class="xref py py-class docutils literal notranslate"><span class="pre">CSXCAD.CSProperties.CSPropDumpBox</span></code></a>.</p>
</div>
<p>In this example, we will dump the total current density (<code class="docutils literal notranslate"><span class="pre">dump_type=3</span></code>) on
the upper waveguide plate as a 2D surface, using the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">AddDump`()</span></code> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dump</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">AddDump</span><span class="p">(</span><span class="s2">&quot;curl_H_upper&quot;</span><span class="p">,</span> <span class="n">dump_type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">dump</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>openEMS obtains the total current density by calculating
<span class="math notranslate nohighlight">\(\mathrm{\nabla} \times \mathbf{H}\)</span>, which is
<span class="math notranslate nohighlight">\(\mathbf{J} + \frac{\partial \mathbf{D}}{\partial t}\)</span>
(i.e. the sum of conduction current and displacement current).</p>
</div>
</section>
<section id="purpose-of-ports">
<span id="port"></span><h2>Purpose of Ports<a class="headerlink" href="#purpose-of-ports" title="Permalink to this headline"></a></h2>
<p>The bulk of the 3D modeling work is nearly complete. The final step is
introducing a port and its excitation signal.</p>
<p>Ports are best understood as the 3D virtual equivalent of physical ports
on RF/microwave components, such as the 50 Ω input or output ports on
circuit boards, signal generators, oscilloscopes, and especially Vector
Network Analyzers (VNA). It’s a lumped circuit with a negligible size.
It acts as a voltage source with a resistive output impedance, and it
can inject or measure a voltage at the Device-Under-Test (DUT).</p>
<figure class="align-default" id="id24">
<a class="with-border reference internal image-reference" href="../../../_images/vna_ports.svg"><img alt="../../../_images/vna_ports.svg" class="with-border" src="../../../_images/vna_ports.svg" width="49%" /></a>
<figcaption>
<p><span class="caption-text">The “port” in openEMS serves the same purpose similar to the physical
ports on Vector Network Analyzers and circuit boards, both kinds of
ports are used to inject an input signal at a particular point of the
Device-Under-Test (DUT), and to measure what comes out at another point.
The DUT is thus characterized as a blackbox. The internal implementations
of ports are obviously different in the digital and physical worlds, though
(image by Julien Hillairet, from the <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> project, licensed
under BSD-3, modified for clarity).</span><a class="headerlink" href="#id24" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Internally, it’s implemented by setting the electric fields in the Yee’s
cells located at positions occupied by the port, according to the waveform
of the excitation signal. Thus it can be physically understood as a source
that injects electromagnetic energy into the simulation, providing the
initial conditions for the system. Simultaneously, a lumped resistor and
a probe is also created at the same location of the port, allowing it to
provide a load for the signal, or to measure the voltage or current at
this region.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Like physical ports on devices and instruments, they’re not ideal in openEMS.
A port creates a region of discontinuity, so they may introduce artifacts.
Optimizing the placement and implementation of a port reduces artifacts.
For example, in addition to the generic lumped port
(<a class="reference internal" href="../openEMS.html#openEMS.openEMS.AddLumpedPort" title="openEMS.openEMS.AddLumpedPort"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AddLumpedPort()</span></code></a>), openEMS contains optimized
ports for curved ports (<code class="docutils literal notranslate"><span class="pre">AddCurvePort.m</span></code>), microstrip
(<a class="reference internal" href="../ports.html#openEMS.ports.MSLPort" title="openEMS.ports.MSLPort"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MSLPort()</span></code></a>), stripline (<code class="docutils literal notranslate"><span class="pre">AddStripLinePort.m</span></code>),
coplanar waveguide (<code class="docutils literal notranslate"><span class="pre">AddCPWPort.m</span></code>), coax cables
(<code class="docutils literal notranslate"><span class="pre">AddCoaxialPort.m</span></code>), generic waveguides
(<a class="reference internal" href="../ports.html#openEMS.ports.WaveguidePort" title="openEMS.ports.WaveguidePort"><code class="xref py py-meth docutils literal notranslate"><span class="pre">WaveguidePort()</span></code></a>), rectangular waveguides
(<a class="reference internal" href="../ports.html#openEMS.ports.RectWGPort" title="openEMS.ports.RectWGPort"><code class="xref py py-meth docutils literal notranslate"><span class="pre">RectWGPort()</span></code></a>), circular waveguides
(<code class="docutils literal notranslate"><span class="pre">AddCircWaveGuidePort.m</span></code>)</p>
<p>Some of them are not, cough, <em>ported</em> to Python yet. But for now, the lumped
ports suffice for our purpose. Alternatively, these artifacts sometimes
can also be removed through calibration or de-embedding algorithms, an
advanced topic not discussed here.</p>
<p>Sometimes, a port can’t even excite the structure properly. For example,
in a rectangular waveguide has only one conductor (our TEM “waveguide”
have two like an ordinary transmission line), one must use a special
waveguide port to excite a TE-mode electromagnetic wave.</p>
<figure class="align-default" id="id25">
<a class="with-border reference internal image-reference" href="../../../_images/error-box.svg"><img alt="../../../_images/error-box.svg" class="with-border" src="../../../_images/error-box.svg" width="60%" /></a>
<figcaption>
<p><span class="caption-text">The artifacts introduced by a two-port measurement can be viewed
as two linear circuits (left error box, right error box) cascaded in
series with the DUT. All three circuits are represented as three matrices,
called their S-parameters. Measurement error can be reduced by making
error boxes close to unity with optimized port transitions.
Alternatively, by mathematically removing the port’s contributions from
the measured response using linear algebra, a process known as
calibration or de-embedding (image by Ziad Hatab, Michael Ernst Gadringer,
and Wolfgang Bösch, from <em>Indirect Measurement of Switch
Terms of a Vector Network Analyzer with Reciprocal Devices</em>, licensed
under CC BY-SA 4.0).</span><a class="headerlink" href="#id25" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</div>
<section id="test-fixture-as-1-port-or-2-port-network">
<h3>Test Fixture as 1-Port or 2-Port Network<a class="headerlink" href="#test-fixture-as-1-port-or-2-port-network" title="Permalink to this headline"></a></h3>
<p>To analyze the frequency response of the DUT, both 1-port and 2-port
measurements can be made. In a 1-port measurement (<em>shunt</em> method),
a signal is injected into the DUT using a 50 Ω port, and the reflected
signal at the same port is measured. In a 2-port measurement, the DUT is
connected either in series (<em>series</em> method) or parallel (<em>shunt-through</em>
method) between the transmitter and receiver.
A signal is injected into the DUT using a 50 Ω transmitter port, and the
received signal is measured by the 50 Ω receiver port at the other side.
The latter techniques are shown in the following circuit diagram (the
impedance <code class="docutils literal notranslate"><span class="pre">Z</span></code> is a function of frequency).</p>
<figure class="align-default" id="id26">
<img alt="../../../_images/vna-shunt-thru-series.svg" class="with-border" src="../../../_images/vna-shunt-thru-series.svg" /><figcaption>
<p><span class="caption-text">2-port shunt-through measurement (DUT in parallel), and 2-port series
(DUT in series) measurement.</span><a class="headerlink" href="#id26" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>In the real world, the 1-port measurement method is only accurate when
the DUT’s impedance is close to the system impedance. If the impedance
of the DUT too high or too low, almost all energy is reflected back.
Small differences between strong reflections are hard to distinguish.
For low-impedance DUTs, results are also sensitive to the port’s contact
resistance. Both result in significant measurement errors.</p>
<p>Instead, two-port measurements detect the weak signal transmitted across
DUT (“filtered” by a large series impedance or a low parallel impedance),
taking advantage of the sensitive radio receiver in the VNA. This allows
us to solve the DUT’s impedance.</p>
<p>To illustrate the general principle of two-port networks and S-parameters
in microwave measurements, we follow the 2-port method here.</p>
</section>
</section>
<section id="create-ports">
<h2>Create Ports<a class="headerlink" href="#create-ports" title="Permalink to this headline"></a></h2>
<p>Ports and excitations are related to the FDTD simulation, not just the
3D structure, so they can be added only after associating our CSXCAD
structure with the FDTD simulation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">openEMS</span>
<span class="n">fdtd</span> <span class="o">=</span> <span class="n">openEMS</span><span class="o">.</span><span class="n">openEMS</span><span class="p">()</span>
<span class="n">fdtd</span><span class="o">.</span><span class="n">SetCSX</span><span class="p">(</span><span class="n">csx</span><span class="p">)</span>
</pre></div>
</div>
<p>To use a lumped port, call <code class="docutils literal notranslate"><span class="pre">openEMS</span></code> object’s
<a class="reference internal" href="../openEMS.html#openEMS.openEMS.AddLumpedPort" title="openEMS.openEMS.AddLumpedPort"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AddLumpedPort()</span></code></a> method.</p>
<p>Let’s create two ports at the leftmost and rightmost sides of the
waveguide. Port 1 should be centered at x = -50, y = 0, and the Port 2
should be centered at x = 50, y = 0. Lumped ports should touch both
waveguide plates, as the port is connected across them, so their Z
coordinates span from [-8, 8]. This matches the intuition of a
circuit diagram, in which a lumped port is vertically connected
across the horizontal transmission line. The port’s internal voltage
source acting as both a wire and a source of electric field.</p>
<figure class="align-default" id="id27">
<img alt="../../../_images/lumped-port.svg" class="with-border" src="../../../_images/lumped-port.svg" /><figcaption>
<p><span class="caption-text">An ideal lumped port is connected vertically across a horizontal
circuit. Its internal voltage source acting as both a wire and a
source of electric field. An lumped excitation port in openEMS
works similarly here.</span><a class="headerlink" href="#id27" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>To complicate the issue further, a port must cross at least a mesh line, since
excitation is implemented by setting the electric field at the corresponding
Yee’s cells. Since we have enforced the 1/3-2/3 rule, if the port is placed
exactly at the edge of the plate, no mesh lines pass through the port. Thus,
as a compromise, we shift the port’s location to the nearest mesh lines instead,
this may introduce a small error due to shifted measurement plane. But these
issues are negligible for this demo.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A port must cross or align exactly with at least one mesh line, otherwise
it can’t be simulated.</p>
</div>
<p>Another question is whether the port should have a length and width. For
transmission line simulations, the answer is often yes (especially for
transmission line simulation) - the port should have a width as wide as the
transmission line to minimize discontinuity. On the other hand, one can usually
keep the length 0. Here to make the problem more interesting, we simulate a
port with a 5 mm width - much smaller than the width of the plates.</p>
<p>Both ports have an input (or output) impedance of 50 Ω, but only the first
port is used for excitation (input), so we set Port 1’s <code class="docutils literal notranslate"><span class="pre">excite</span></code> attribute
to <code class="docutils literal notranslate"><span class="pre">1</span></code>, and Port 2’s <code class="docutils literal notranslate"><span class="pre">excite</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">0</span></code>. The parameter <code class="docutils literal notranslate"><span class="pre">z</span></code> is
the direction of the field, pointing from one plate to another on the Z axis.</p>
<p>Both ports are also added to a Python list to keep track of them for
future processing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">z0</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>TODO: add AppCSXCAD screenshots here.</p>
</div>
</section>
<section id="create-excitation">
<h2>Create Excitation<a class="headerlink" href="#create-excitation" title="Permalink to this headline"></a></h2>
<p>We need to assign an input signal to the excitation port.</p>
<p>In FDTD simulations, a Gaussian pulse is normally used as it provides a
wideband and smooth signal without discontinuous jumps. In openEMS,
the Gaussian pulse is implemented as a sinusoidal carrier at the center
frequency, with its amplitude modulated by a Gaussian function. This signal
produces an optimized spectrum with a wide range of frequencies in both
sidebands around the carrier. This relatively clean spectrum enables
openEMS to accurately extract the DUT’s frequency response in the
frequency domain.</p>
<p>Once the DUT’s frequency response is known, linear circuit analysis
tools can evaluate its behavior under other input signals, so there’s
no loss of generality.</p>
<a class="reference internal image-reference" href="../../../_images/port1_vt_input.svg"><img alt="../../../_images/port1_vt_input.svg" src="../../../_images/port1_vt_input.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/port1_vt_fft.svg"><img alt="../../../_images/port1_vt_fft.svg" src="../../../_images/port1_vt_fft.svg" width="49%" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In contrast, pulses such as the Dirac impulse
(<a class="reference internal" href="../openEMS.html#openEMS.openEMS.SetDiracExcite" title="openEMS.openEMS.SetDiracExcite"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SetDiracExcite()</span></code></a>) or the Heaviside step
function (<a class="reference internal" href="../openEMS.html#openEMS.openEMS.SetStepExcite" title="openEMS.openEMS.SetStepExcite"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SetStepExcite()</span></code></a>) has discontinuous
jumps, reaching the full value in just a single timestep. This can
cause numerical problems like dispersion and unrealistic excitation
of high-order modes. As a workaround, users can provide custom
bandwidth-limited expressions to openEMS (no built-in implementations
exist currently) via <a class="reference internal" href="../openEMS.html#openEMS.openEMS.SetCustomExcite" title="openEMS.openEMS.SetCustomExcite"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SetCustomExcite()</span></code></a>. For an
example, see <a class="footnote-reference brackets" href="#id19" id="id2">7</a>.  However, these pulses also suffer from rapid energy
roll-off at high frequencies. The Gaussian pulse, by comparison,
retains significant energy in both sidebands around the center carrier
frequency.</p>
</div>
<p>To apply a Gaussian excitation, we call <a class="reference internal" href="../openEMS.html#openEMS.openEMS.SetGaussExcite" title="openEMS.openEMS.SetGaussExcite"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SetGaussExcite()</span></code></a>
of the <code class="docutils literal notranslate"><span class="pre">openEMS</span></code> object. The first argument is its center frequency,
the second argument is its -20 dB bandwidth, defining the signal’s
spectral “spread”. For a wideband simulation, both arguments should
be set to 1/2 of the simulation’s upper frequency target::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Centered around 5 GHz with a 5 GHz 20 dB bandwidth.</span>
<span class="c1"># Lower sideband covers 0 - 5 GHz, upper sideband cover 5 - 10 GHz.</span>
<span class="n">fdtd</span><span class="o">.</span><span class="n">SetGaussExcite</span><span class="p">(</span><span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="specify-the-boundary-conditions">
<h2>Specify the Boundary Conditions<a class="headerlink" href="#specify-the-boundary-conditions" title="Permalink to this headline"></a></h2>
<p>In openEMS, all physical phenomena occur in a small simulation box, so
we’re forced to decide what happens to the electromagnetic fields at its
edges. This is known as the <em>boundary conditions</em> of Partial Differential
Equations (PDE). To create an effective simulation, we must select the
appropriate boundary conditions. There are six in total, located at
the six faces of the box: <code class="docutils literal notranslate"><span class="pre">x_min</span></code>, <code class="docutils literal notranslate"><span class="pre">x_max</span></code>, <code class="docutils literal notranslate"><span class="pre">y_min</span></code>, <code class="docutils literal notranslate"><span class="pre">y_max</span></code>,
<code class="docutils literal notranslate"><span class="pre">z_min</span></code>, <code class="docutils literal notranslate"><span class="pre">z_max</span></code>.</p>
<section id="reflecting-dirichlet-boundary-conditions">
<h3>Reflecting (Dirichlet) Boundary Conditions<a class="headerlink" href="#reflecting-dirichlet-boundary-conditions" title="Permalink to this headline"></a></h3>
<p>If the finite nature of the simulation box and the reflection of E&amp;M waves at
the boundaries are acceptable, reflecting boundary conditions offer a simple
zero-overhead solution. They efficiently model structures inside metal
enclosure, above a ground plane, or with an electric or magnetic field
symmetry across a plane. No explicit modeling is necessary, the boundary
conditions implicitly enforce these behaviors.</p>
<figure class="align-default" id="id28">
<a class="with-border reference internal image-reference" href="../../../_images/reverberation_chamber.jpg"><img alt="../../../_images/reverberation_chamber.jpg" class="with-border" src="../../../_images/reverberation_chamber.jpg" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-text">A simulation box with PEC at all boundaries acts like a shielded enclosure
or a reverberation chamber, commonly used in EMC test labs. Image by Dr.
Hans Georg Krauthäuser (Hgk at English Wikipedia), licensed under CC
BY-SA 3.0.</span><a class="headerlink" href="#id28" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p><strong>Perfect Electric Conductor (PEC)</strong>: The simplest treatment sets
the (tangential) electric field at the boundary to 0.
Since the electric field lines can’t penetrate this boundary, it’s
equivalent to a Perfect Electric Conductor (PEC) with infinite
conductivity, also known as an Electric Wall. All incoming waves are
fully reflected back, analogous to a 1D transmission line terminated
by a short circuit.</p>
<p><strong>Perfect Magnetic Conductor (PMC)</strong>: By duality, it sets the magnetic
field to 0 at the boundary. It acts as a boundary at which
the magnetic field lines can’t penetrate. It’s equivalent to a Perfect
Magnetic Conductor (PMC) with infinite permeability, also known as the
Magnetic Wall. All incoming waves are fully reflected back as well,
but with a phase opposite to that of the PEC, analogous to a 1D
transmission line terminated by an open circuit. No material in the
real world approximates a PMC, so it’s used as a mathematical tool
for structures with symmetry across a plane.</p>
<p>Mathematically, both PEC and PMC are Dirichlet boundary conditions,
enforce fixed field values (e.g. zero).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For our simulation, instead of explicitly modeling metal
plates, we can model a vacuum with nothing inside, taking advantage
of the PEC boundary conditions at <code class="docutils literal notranslate"><span class="pre">z_min</span></code> and <code class="docutils literal notranslate"><span class="pre">z_max</span></code> for
fast computation. But this is out of the scope of this tutorial, and it
won’t capture the fringe fields above and below. So we will not use
PEC or PMC for any boundaries in this example.</p>
</div>
</section>
<section id="absorbing-boundary-conditions-abc">
<h3>Absorbing Boundary Conditions (ABC)<a class="headerlink" href="#absorbing-boundary-conditions-abc" title="Permalink to this headline"></a></h3>
<p>For this demo, the most intuitive kind of boundary conditions here are
the <em>Absorbing Boundary Conditions (ABC)</em>. First we create a simulation
box larger than the device, allowing some fringe fields. Then, at the
boundaries, the electromagnetic waves are absorbed without coming back
to the box, creating the illusion of an infinite-size free space.</p>
<figure class="align-default" id="id29">
<a class="with-border reference internal image-reference" href="../../../_images/anechoic_chamber.jpg"><img alt="../../../_images/anechoic_chamber.jpg" class="with-border" src="../../../_images/anechoic_chamber.jpg" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-text">A simulation box with PML at all boundaries acts like an anechoic chamber
in an EMC test lab. Image by Adamantios (at English Wikipedia), licensed
under CC BY-SA 3.0.</span><a class="headerlink" href="#id29" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Two kinds of Absorbing Boundary Conditions are implemented in openEMS.</p>
<ol class="arabic">
<li><p><em>Mur’s Boundary Condition (MUR)</em>. Mur’s Boundary Condition is a
first-generation boundary condition purely defined by differential
equations, originally invented by Gerrit Mur in the 1980s. It has
a moderate computational overhead, but it works only if the E&amp;M wave
is orthogonal to the boundary and has a well-defined phase velocity
(e.g. the speed of light). Thus, reflections may cause errors if
strong radiation exists due to imperfect absorption.</p></li>
<li><p><em>Perfect Matched Layer (PML)</em>. Perfect Matched Layer is the
second-generation boundary condition proposed in the 1990s, modeling
the behavior of a hypothetical E&amp;M wave-absorbing material. Unlike
Mur’s ABC, PML occupies some physical cells in the simulation box
(the actual boundary at the true edge remains PEC.).
This mimics the foams on the wall of an anechoic chamber in EMC test
labs.</p>
<p>PML is a more effective absorber and is easy to use, but it has the
highest computational overhead (especially in openEMS, due to suboptimal
implementation). Avoid it if efficiency is critical (e.g. only use
PML at the simulation box’s face directly hit by radiation, and use
MUR for other boundaries). Intrusion of fringe fields and evanescent
waves into the PML can destabilize it. Radiating structures must be kept
a distance of <span class="math notranslate nohighlight">\(\lambda / 4\)</span>.</p>
</li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In openEMS, <code class="docutils literal notranslate"><span class="pre">PML_8</span></code> is commonly used, meaning the nearest 8 mesh lines
of the simulation box are dedicated to the PML. This is an assumption made
by the simulator and not visible in AppCSXCAD. Ensure your structure do not
overlap with edge cells (unless intentionally terminating a region with
the PML). Radiating structures must be kept a distance of <span class="math notranslate nohighlight">\(\lambda / 4\)</span>
from PML as intrusion of fringe fields and evanescent waves can create
numerical instability.</p>
</div>
</section>
<section id="set-boundary-conditions">
<h3>Set Boundary Conditions<a class="headerlink" href="#set-boundary-conditions" title="Permalink to this headline"></a></h3>
<p>To set the boundary conditions of the simulator, use
<a class="reference internal" href="../openEMS.html#openEMS.openEMS.SetBoundaryCond" title="openEMS.openEMS.SetBoundaryCond"><code class="xref py py-meth docutils literal notranslate"><span class="pre">openEMS.openEMS.SetBoundaryCond()</span></code></a> of the <code class="docutils literal notranslate"><span class="pre">openEMS</span></code> class. Its syntax is:
<code class="docutils literal notranslate"><span class="pre">SetBoundaryCond(bc)</span></code> in which <code class="docutils literal notranslate"><span class="pre">bc</span></code> is a list with 6 elements with the order
of <code class="docutils literal notranslate"><span class="pre">[x_min,</span> <span class="pre">x_max,</span> <span class="pre">y_min,</span> <span class="pre">y_max,</span> <span class="pre">z_min,</span> <span class="pre">z_max]</span></code>. Each element is a string or
integer according to the following table. Note that the use of integers are
discouraged due to poor readability, but one may encounter them in older examples.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 31%" />
<col style="width: 12%" />
<col style="width: 4%" />
<col style="width: 53%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Boundary Condition</p></th>
<th class="head"><p>String</p></th>
<th class="head"><p>ID</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Perfect Electric Conductor</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PEC</span></code></p></td>
<td><p>0</p></td>
<td><p>Reflective. Fast.</p></td>
</tr>
<tr class="row-odd"><td><p>Perfect Magnetic Conductor</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PMC</span></code></p></td>
<td><p>1</p></td>
<td><p>Reflective. Fast.</p></td>
</tr>
<tr class="row-even"><td><p>Mur’s Absorbing Boundary</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MUR</span></code></p></td>
<td><p>2</p></td>
<td><p>Absorbing. Slow.</p>
<p>Only absorbs waves normal to the boundary.</p>
<p>Named after Gerrit Mur.</p>
</td>
</tr>
<tr class="row-odd"><td><p>Perfect Matched Layer</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">PML_8</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">PML_x</span></code></p>
</td>
<td><p>3</p></td>
<td><p>Absorbing. Slowest.</p>
<p><code class="docutils literal notranslate"><span class="pre">x</span></code> has a range [6, 20], 8 by default.</p>
<p>Occupies <code class="docutils literal notranslate"><span class="pre">x</span></code> mesh lines near the boundary.</p>
<p>Keep structures <code class="docutils literal notranslate"><span class="pre">x</span></code> cells away from boundary.</p>
<p>For radiating structures, λ / 4 away.</p>
</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">PML_8</span></code> is the boundary condition that we’re going to use, so we write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fdtd</span><span class="o">.</span><span class="n">SetBoundaryCond</span><span class="p">([</span><span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="start-simulation">
<h2>Start Simulation<a class="headerlink" href="#start-simulation" title="Permalink to this headline"></a></h2>
<p>Finally, to start the simulation, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fdtd</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">simdir</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="code-checkpoint-1">
<h2>Code Checkpoint 1<a class="headerlink" href="#code-checkpoint-1" title="Permalink to this headline"></a></h2>
<section id="our-existing-code-so-far">
<h3>Our Existing Code So Far<a class="headerlink" href="#our-existing-code-so-far" title="Permalink to this headline"></a></h3>
<p>As a checkpoint of our progress, the following is the complete code one
obtains if the previous instructions are followed. Note that in this code
snippet, we rearranged the order of some lines according to Python’s coding
convention of import first, constant definitions second, and main logic the
last:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">CSXCAD</span>
<span class="kn">import</span> <span class="nn">openEMS</span>
<span class="kn">from</span> <span class="nn">openEMS.physical_constants</span> <span class="kn">import</span> <span class="n">C0</span>

<span class="c1"># calculate mesh resolution according to simulation frequency</span>
<span class="n">unit</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="mf">10e9</span>
<span class="n">epsilon_r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon_r</span><span class="p">)</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">f_max</span> <span class="o">/</span> <span class="n">unit</span>  <span class="c1"># convert to millimeters</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="mi">10</span>

<span class="c1"># port impedance</span>
<span class="n">z0</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># determine the simulation output path</span>

<span class="c1"># find the directory of the script itself</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="c1"># create a directory named after the script, but without &quot;.py&quot;</span>
<span class="n">simdir</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">simdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># find the filename of the script itself, and replace &quot;.py&quot; with &quot;.xml&quot;</span>
<span class="n">xmlname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<span class="c1"># concat path</span>
<span class="n">xmlpath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">xmlname</span>

<span class="n">csx</span> <span class="o">=</span> <span class="n">CSXCAD</span><span class="o">.</span><span class="n">ContinuousStructure</span><span class="p">()</span>
<span class="n">fdtd</span> <span class="o">=</span> <span class="n">openEMS</span><span class="o">.</span><span class="n">openEMS</span><span class="p">()</span>

<span class="c1"># associate the CSXCAD structure with the FDTD simulator</span>
<span class="n">fdtd</span><span class="o">.</span><span class="n">SetCSX</span><span class="p">(</span><span class="n">csx</span><span class="p">)</span>

<span class="c1"># set unit of measurement in the CSXCAD drawing</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">GetGrid</span><span class="p">()</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SetDeltaUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>

<span class="c1"># Create an instance of material named &quot;plate&quot;.</span>
<span class="c1"># AddMetal() creates a Perfect Electric Conductor.</span>
<span class="n">metal</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">AddMetal</span><span class="p">(</span><span class="s1">&#39;plate&#39;</span><span class="p">)</span>

<span class="c1"># Build two 3D shapes from -50 to 50 on the X/Y axes, located at Z = -8</span>
<span class="c1"># and Z = 8 respectively. Note that the starting and stopping Z coordinates</span>
<span class="c1"># of each plate are the same, so these metal plates have zero thickness.</span>
<span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># lower plate</span>
<span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">])</span>  <span class="c1"># upper plate</span>

<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span>   <span class="mi">50</span><span class="p">])</span>  <span class="c1"># two lines at -50, 50</span>

<span class="c1"># strategically draw lines misaligned with the waveguide&#39;s left and right edges,</span>
<span class="c1"># so that the edge occupies a cell by 33%.</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the X axis</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the Y axis</span>

<span class="c1"># zero-thickness metal plates need mesh lines at their exact levels</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>    <span class="c1"># two lines at -8, 8</span>

<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># save structure to file for inspection</span>
<span class="n">csx</span><span class="o">.</span><span class="n">Write2XML</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xmlpath</span><span class="p">))</span>

<span class="c1"># Centered around 5 GHz with a 5 GHz 20 dB bandwidth.</span>
<span class="c1"># Lower sideband covers 0 - 5 GHz, upper sideband cover 5 - 10 GHz.</span>
<span class="n">fdtd</span><span class="o">.</span><span class="n">SetGaussExcite</span><span class="p">(</span><span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">fdtd</span><span class="o">.</span><span class="n">SetBoundaryCond</span><span class="p">([</span><span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">])</span>
<span class="n">fdtd</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">simdir</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="code-refactoring">
<h3>Code Refactoring<a class="headerlink" href="#code-refactoring" title="Permalink to this headline"></a></h3>
<p>The program above is not entirely satisfactory. If we want make some
small adjustment to the model, it forces us to run the simulation. For
improved modularity, the 3D modeling, ports creation, simulation, and
post-processing should each be written in separated functions, so each
part can be ran and reran separately. This is important for repeated
simulations with different parameters, which are encountered in all
but the most trivial simulations.</p>
<p>The following refactored program provides a reasonable skeleton to
build upon further:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">CSXCAD</span>
<span class="kn">import</span> <span class="nn">openEMS</span>
<span class="kn">from</span> <span class="nn">openEMS.physical_constants</span> <span class="kn">import</span> <span class="n">C0</span>

<span class="c1"># calculate mesh resolution according to simulation frequency</span>
<span class="n">unit</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="mf">10e9</span>
<span class="n">epsilon_r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon_r</span><span class="p">)</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">f_max</span> <span class="o">/</span> <span class="n">unit</span>  <span class="c1"># convert to millimeters</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="mi">10</span>

<span class="c1"># port impedance</span>
<span class="n">z0</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># determine the simulation output path</span>

<span class="c1"># find the directory of the script itself</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="c1"># use a directory named after the script, but without &quot;.py&quot;</span>
<span class="n">simdir</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">simdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># find the filename of the script itself, and replace &quot;.py&quot; with &quot;.xml&quot;</span>
<span class="n">xmlname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># concat path</span>
<span class="n">xmlpath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">xmlname</span>


<span class="k">def</span> <span class="nf">generate_structure</span><span class="p">(</span><span class="n">csx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate and return the 3D structure used for simulation.</span>

<span class="sd">    This function should return a CSXCAD instance, but without changing any</span>
<span class="sd">    simulation parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set unit of measurement in the CSXCAD drawing</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">GetGrid</span><span class="p">()</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">SetDeltaUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>

    <span class="c1"># Create an instance of material named &quot;plate&quot;.</span>
    <span class="c1"># AddMetal() creates a Perfect Electric Conductor.</span>
    <span class="n">metal</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">AddMetal</span><span class="p">(</span><span class="s1">&#39;plate&#39;</span><span class="p">)</span>

    <span class="c1"># Build two 3D shapes from -50 to 50 on the X/Y axes, located at Z = -8</span>
    <span class="c1"># and Z = 8 respectively. Note that the starting and stopping Z coordinates</span>
    <span class="c1"># of each plate are the same, so these metal plates have zero thickness.</span>
    <span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># lower plate</span>
    <span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">])</span>  <span class="c1"># upper plate</span>

    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span>   <span class="mi">50</span><span class="p">])</span>  <span class="c1"># two lines at -50, 50</span>

    <span class="c1"># strategically draw lines misaligned with the waveguide&#39;s left and right edges,</span>
    <span class="c1"># so that the edge occupies a cell by 33%.</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the X axis</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the Y axis</span>

    <span class="c1"># zero-thickness metal plates need mesh lines at their exact levels</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>    <span class="c1"># two lines at -8, 8</span>

    <span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">csx</span>


<span class="k">def</span> <span class="nf">setup_ports</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and return ports to inject and measure signals at a particular mesh</span>
<span class="sd">    location.</span>

<span class="sd">    This function should only create ports, but without changing the structure</span>
<span class="sd">    or simulation parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">port</span>


<span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup boundary conditions, excitation signals, and finally run the</span>
<span class="sd">    simulator.</span>

<span class="sd">    This function should run the simulator from the given &quot;fdtd&quot; and &quot;csx&quot;</span>
<span class="sd">    instance, without changing them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Centered around 5 GHz with a 5 GHz 20 dB bandwidth.</span>
    <span class="c1"># Lower sideband covers 0 - 5 GHz, upper sideband cover 5 - 10 GHz.</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">SetGaussExcite</span><span class="p">(</span><span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">SetBoundaryCond</span><span class="p">([</span><span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">])</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">simdir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">postproc</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the data generated by a complete simulation. Only knowledge of ports</span>
<span class="sd">    are necessary. This function is agnostic about the structure and simulator</span>
<span class="sd">    parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">csx</span> <span class="o">=</span> <span class="n">CSXCAD</span><span class="o">.</span><span class="n">ContinuousStructure</span><span class="p">()</span>
    <span class="n">fdtd</span> <span class="o">=</span> <span class="n">openEMS</span><span class="o">.</span><span class="n">openEMS</span><span class="p">()</span>

    <span class="c1"># associate CSXCAD structure with an openEMS simulation</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">SetCSX</span><span class="p">(</span><span class="n">csx</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No command given, expect &quot;generate&quot;, &quot;simulate&quot;, &quot;postproc&quot;&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;generate&quot;</span><span class="p">,</span> <span class="s2">&quot;simulate&quot;</span><span class="p">]:</span>
        <span class="c1"># generate 3D structure</span>
        <span class="n">generate_structure</span><span class="p">(</span><span class="n">csx</span><span class="p">)</span>
        <span class="n">setup_ports</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">)</span>
        <span class="n">csx</span><span class="o">.</span><span class="n">Write2XML</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xmlpath</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simulate&quot;</span><span class="p">:</span>
            <span class="c1"># run simulator</span>
            <span class="n">simulate</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;postproc&quot;</span><span class="p">:</span>
        <span class="c1"># run post-processing only, without running the simulator</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">setup_ports</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">)</span>
        <span class="n">postproc</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown command </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>This program accepts three separate commands: <code class="docutils literal notranslate"><span class="pre">generate</span></code>, <code class="docutils literal notranslate"><span class="pre">simulate</span></code>,
and <code class="docutils literal notranslate"><span class="pre">postproc</span></code>. This allows incremental development.</p>
<p>One can immediately inspect the model in AppCSXCAD without starting
the simulation via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">waveguide</span><span class="o">.</span><span class="n">py</span> <span class="n">generate</span>
</pre></div>
</div>
<p>Once checked, one can manually start the simulation via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">waveguide</span><span class="o">.</span><span class="n">py</span> <span class="n">simulate</span>
</pre></div>
</div>
<p>Likewise, one can experiment with different post-processing
routines based on existing data without wasting time on
re-running the simulation via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">waveguide</span><span class="o">.</span><span class="n">py</span> <span class="n">postproc</span>
</pre></div>
</div>
<p>In the future, it’s also easy to modify the program to add
parameterized structure generation, multi-pass simulations,
and other features.</p>
</section>
</section>
<section id="run-simulation">
<h2>Run Simulation<a class="headerlink" href="#run-simulation" title="Permalink to this headline"></a></h2>
<p>If everything works as expected, the following screen appears. This
simulation should finish within a few minutes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 Parallel_Plate_Capacitor_Waveguide.py
 ----------------------------------------------------------------------
 | openEMS 64bit -- version v0.0.36-16-g7d7688a
 | (C) 2010-2023 Thorsten Liebig &lt;thorsten.liebig@gmx.de&gt;  GPL license
 ----------------------------------------------------------------------
    Used external libraries:
            CSXCAD -- Version: v0.6.3-4-g9257bf1
            hdf5   -- Version: 1.12.1
                      compiled against: HDF5 library version: 1.12.1
            tinyxml -- compiled against: 2.6.2
            fparser
            boost  -- compiled against: 1_76
            vtk -- Version: 9.1.0
                   compiled against: 9.1.0

Create FDTD operator (compressed SSE + multi-threading)
CalcNyquistNum(4756540486875873280,4438156221306557130)
FDTD simulation size: 70x70x37 --&gt; 181300 FDTD cells
FDTD timestep is: 5.3429e-12 s; Nyquist rate: 9 timesteps @1.0398e+10 Hz
Excitation signal length is: 108 timesteps (5.77033e-10s)
Max. number of timesteps: 1000000000 ( --&gt; 9.25926e+06 * Excitation signal length)
Create FDTD engine (compressed SSE + multi-threading)
Running FDTD engine... this may take a while... grab a cup of coffee?!?
[@        4s] Timestep:         1602 || Speed:   72.5 MC/s (2.499e-03 s/TS) || Energy: ~2.70e-19 (-41.66dB)
[@        8s] Timestep:         3820 || Speed:  100.5 MC/s (1.805e-03 s/TS) || Energy: ~5.35e-20 (-48.70dB)
[@       12s] Timestep:         6510 || Speed:  121.9 MC/s (1.488e-03 s/TS) || Energy: ~1.86e-20 (-53.30dB)
[@       16s] Timestep:         9320 || Speed:  127.3 MC/s (1.424e-03 s/TS) || Energy: ~1.09e-20 (-55.59dB)
[@       20s] Timestep:        12136 || Speed:  127.6 MC/s (1.421e-03 s/TS) || Energy: ~5.33e-21 (-58.72dB)
[@       24s] Timestep:        14748 || Speed:  118.4 MC/s (1.532e-03 s/TS) || Energy: ~3.62e-21 (-60.39dB)
Multithreaded Engine: Best performance found using 5 threads.
Time for 14748 iterations with 181300.00 cells : 24.01 sec
Speed: 111.35 MCells/s
</pre></div>
</div>
<p>If there’s a mesh or port alignment alignment problem, openEMS may
generate the following warnings. See the linked sections for their
respective solution.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#unused-plate"><span class="std std-ref">Warning: Unused primitive (type: Box) detected in property: plate!</span></a></p></li>
<li><p><a class="reference internal" href="#unused-excite"><span class="std std-ref">Warning: Unused primitive (type: Box) detected in property: port_excite_1!</span></a></p></li>
<li><p><a class="reference internal" href="#voltage-integral-error"><span class="std std-ref">CalcVoltageIntegral: Error, only a 1D/line integration is allowed</span></a></p></li>
</ul>
</section>
<section id="built-in-post-processing">
<h2>Built-In Post-Processing<a class="headerlink" href="#built-in-post-processing" title="Permalink to this headline"></a></h2>
<p>By now, the electromagnetic field simulation is complete. It’s up to us analyze
and interpret the data.</p>
<p>To analyze the frequency response of the structure, one would need to specify a
discrete list of frequencies of interest. One can generate such a list with the
help of numpy’s <code class="docutils literal notranslate"><span class="pre">linspace()</span></code> function. The following code creates a <code class="docutils literal notranslate"><span class="pre">freq_list</span></code>
with 1000 evenly-spaced elements from 100 MHz to 10 GHz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">points</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">freq_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">100e6</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, call the <code class="xref py py-meth docutils literal notranslate"><span class="pre">CalcPort()</span></code> function at each port object one
by one to calculate its response. This is the reason that we’ve chosen to
append each port object into a list called <code class="docutils literal notranslate"><span class="pre">port</span></code>, instead of leaving them
as individual variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">port</span><span class="p">:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">CalcPort</span><span class="p">(</span><span class="n">simdir</span><span class="p">,</span> <span class="n">freq_list</span><span class="p">,</span> <span class="n">ref_impedance</span><span class="o">=</span><span class="n">z0</span><span class="p">)</span>
</pre></div>
</div>
<section id="port-attribute-references">
<h3>Port Attribute References<a class="headerlink" href="#port-attribute-references" title="Permalink to this headline"></a></h3>
<p>The following port attributes are often necessary in post-processing
for frequency response, impedance, and time-domain calculations.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 18%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Domain</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">uf_inc[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Incident Voltage</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">uf_ref[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Reflected Voltage</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">if_tot[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Total Voltage</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">if_inc[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Incident Current</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">if_ref[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Reflected Current</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">if_tot[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Total Current</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">P_inc[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Incident Power</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">P_ref[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Reflected Power</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">P_acc[n]</span></code></p></td>
<td><p>Frequency Sample</p></td>
<td><p>Accepted Power (Incident - Reflected)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ut_inc[n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Incident Voltage</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ut_ref[n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Reflected Voltage</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">it_tot[n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Total Voltage</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">it_inc[n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Incident Current</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">it_ref[n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Reflected Current</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">it_tot[n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Total Current</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">u_data.ui_val[0][n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Raw Voltage (<code class="docutils literal notranslate"><span class="pre">ut_tot</span></code> Recommended)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">u_data.ui_time[0][n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Raw Time of Voltage Samples</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">i_data.ui_val[0][n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Raw Current (<code class="docutils literal notranslate"><span class="pre">it_tot</span></code> Recommended)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">i_data.ui_time[0][n]</span></code></p></td>
<td><p>Time Sample</p></td>
<td><p>Raw Time of Current Samples</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><p>Note for Americans: <code class="docutils literal notranslate"><span class="pre">u</span></code> is the symbol of voltage (U) in ISO/IEC convention.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="introduction-to-s-parameters">
<h3>Introduction to S-parameters<a class="headerlink" href="#introduction-to-s-parameters" title="Permalink to this headline"></a></h3>
<p>In radio and high-speed digital electronics engineering, the <em>S-parameters</em>
are the universal language to express the characteristics of a linear circuit,
allowing one to treat the an circuit as a blackbox with several <em>ports</em>, with
their input-output relationships parameterized.</p>
<p>For a two-port measurement, the circuit is modeled by a 2x2 matrix with 4
complex numbers at each frequency of interest. These parameters can be interpreted
as the transmission and reflection of voltage waves in a transmission line.</p>
<table class="colwidths-given docutils align-center">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="math notranslate nohighlight">
\[\begin{split}\large{
\begin{bmatrix}
b_1 \\ b_2 \end{bmatrix} =
\begin{bmatrix} S_{11} &amp; S_{12} \\
S_{21} &amp; S_{22} \end{bmatrix}
\begin{bmatrix} a_1 \\ a_2
\end{bmatrix}
}\end{split}\]</div>
</td>
<td><p><img alt="s_param_filter" src="../../../_images/s_param_filter.jpg" /></p></td>
</tr>
<tr class="row-even"><td colspan="2"><p>S-parameters can be understood as the transmitted and reflected signals (voltage waves) at the</p>
<p>port of a DUT. The DUT itself is seen as a blackbox, defined only by their input-output relationship</p>
<p>Image by Charly Whisky, licensed under CC BY-SA 4.0.</p>
</td>
</tr>
</tbody>
</table>
<p>At Port 1, its total voltage can be seen as a superposition of two parts:
an incident voltage wave transmitted from port 1, and a reflected wave going back
to port 1. Their ratio <span class="math notranslate nohighlight">\(V_\mathrm{ref} / V_\mathrm{inc}\)</span> is the parameter
<span class="math notranslate nohighlight">\(S_{11}\)</span>. This parameter has several other names: the reflection
coefficient <span class="math notranslate nohighlight">\(\Gamma = S_{11}\)</span>. When its magnitude is plotted on a log
scale, it’s called the return loss <span class="math notranslate nohighlight">\(-10 \cdot \log_{10}(|S_{11}|^2)\)</span>.</p>
<p>At Port 2, its voltage can also be seen as a ratio of two parts: Voltage
wave transmitted from port 1 and going to port 2, called <span class="math notranslate nohighlight">\(S_{21}\)</span>.
This parameter is also known as transmission coefficient. when its magnitude
is plotted on the log scale, its called the insertion loss
<span class="math notranslate nohighlight">\(-10 \cdot \log_{10}(|S_{21}|^2)\)</span>. This corresponds the attenuation of a
cable or a filter.</p>
<p>Since a circuit may modify both the amplitude and the phase of a voltage
wave, all S-parameters are complex numbers.</p>
</section>
<section id="calculate-s-parameters">
<h3>Calculate S-parameters<a class="headerlink" href="#calculate-s-parameters" title="Permalink to this headline"></a></h3>
<p>In openEMS, after calling <code class="docutils literal notranslate"><span class="pre">CalcPort()</span></code> on a port object, its incident and reflected
voltages can be accessed via its <cite>uf_inc</cite> and <cite>uf_ref</cite> attributes, which is a <cite>numpy</cite>
list with the same number of elements as <code class="docutils literal notranslate"><span class="pre">freq_list</span></code> (which we previously passed to
<code class="docutils literal notranslate"><span class="pre">CalcPort()</span></code>).</p>
<p>Thus, the definition, one can calculate <span class="math notranslate nohighlight">\(S_{11}\)</span> and <span class="math notranslate nohighlight">\(S_{21}\)</span> as the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s11_list</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_ref</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_inc</span>
<span class="n">s21_list</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uf_ref</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_inc</span>
</pre></div>
</div>
<p>We utilize <cite>numpy</cite>’s broadcasting feature here. The quantities <code class="docutils literal notranslate"><span class="pre">uf_ref</span></code> and
<code class="docutils literal notranslate"><span class="pre">uf_inc</span></code> are all frequency-dependent, thus they’re arrays, not scalars. But
instead of looping over each frequency explicitly and adding them to an array,
here, element-wise division is done automatically between every element within
the two <code class="docutils literal notranslate"><span class="pre">numpy.array</span></code>. We will use this feature extensively throughout the
rest of this tutorial.</p>
<p>Two S-parameters <span class="math notranslate nohighlight">\(S_{12}\)</span> and <span class="math notranslate nohighlight">\(S_{22}\)</span> are still missing here. The
correct way of doing so is restarting the simulation again, but with port 2 as
the excitation port instead of port 1. This means that in the general case, we
must refactor our code to move the port creation and simulation logic into separate
functions.</p>
<p>But here, since our parallel-plate waveguide is symmetric and reciprocal, it
doesn’t matter if we excite the left side and terminate the right side, or vice
versa, so we can assume <span class="math notranslate nohighlight">\(S_{12} = S_{21}\)</span> and <span class="math notranslate nohighlight">\(S_{11} = S_{22}\)</span>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># hack: assume symmetry and reciprocity, only correct for passive linear circuit!</span>
<span class="n">s22_list</span> <span class="o">=</span> <span class="n">s11_list</span>
<span class="n">s12_list</span> <span class="o">=</span> <span class="n">s21_list</span>
</pre></div>
</div>
</section>
<section id="plot-s-parameters-via-matplotlib">
<h3>Plot S-parameters via matplotlib<a class="headerlink" href="#plot-s-parameters-via-matplotlib" title="Permalink to this headline"></a></h3>
<p>After going through the long exercise, it’s now a good time to take a
quick look at the S-parameters we’ve obtained, using <cite>matplotlib</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
<p>Here, we’re interested in two types of graphs that all RF/microwave
engineers cares about (Smith charts and more sophisticated analysis
will be introduced later, using third-party software).</p>
<p>The scalar return loss (magnitude of <span class="math notranslate nohighlight">\(S_{11}\)</span> in decibels) on
a line chart shows how much power is reflected by the DUT back to
the input port at each frequencies. A high loss like 20 dB implies no
reflection, indicating a good impedance match or a resonance frequency:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s11_db_list</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s11_list</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s11_db_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S_</span><span class="si">{11}</span><span class="s1">$ dB&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Return Loss (dB)&#39;</span><span class="p">)</span>

<span class="c1"># By convention, return loss values increases downward on the Y axis.</span>
<span class="c1"># This is consistent with the plot shapes on spectrum analyzers, and</span>
<span class="c1"># perhaps explains why the customary &quot;wrong&quot; sign convention is used.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Since <span class="math notranslate nohighlight">\(S_{11}\)</span> is a vector (complex number), we can also plot its
phase angle for completeness. But note that the phase is difficult to
interpret, so the Smith chart (covered later) is a better tool for this
job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s11_deg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s11_list</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s11_deg_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S_</span><span class="si">{11}</span><span class="s1">$ deg&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;S11 Phase (deg)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>As we can see from the plot, there’s a sharp 40 dB notch at 500 MHz,
indicating almost all power is delivered into the load with almost no
reflection. This is usually the sign that the DUT is resonating. Above
2 GHz, the reflection becomes extremely strong, as the return loss is
only between 0 dB to 6 dB, suggesting a serious physical discontinuity
or electrical impedance mismatch.</p>
<a class="reference internal image-reference" href="../../../_images/s11_db_sim.svg"><img alt="../../../_images/s11_db_sim.svg" src="../../../_images/s11_db_sim.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/s11_deg_sim.svg"><img alt="../../../_images/s11_deg_sim.svg" src="../../../_images/s11_deg_sim.svg" width="49%" /></a>
<p>The scalar insertion loss (magnitude of <span class="math notranslate nohighlight">\(S_{21}\)</span> in decibels)
on a line chart shows how much power is transmitted into the second port,
which shows the attenuation of signals at each frequency:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s21_db_list</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s21_list</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s21_db_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S_</span><span class="si">{21}</span><span class="s1">$ dB&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Insertion Loss (dB)&#39;</span><span class="p">)</span>

<span class="c1"># By convention, insertion loss values increases downward on the Y axis.</span>
<span class="c1"># This is consistent with the plot shapes on spectrum analyzers, and</span>
<span class="c1"># perhaps explains why the customary &quot;wrong&quot; sign convention is used.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">s21_deg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s21_list</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s21_deg_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S_</span><span class="si">{21}</span><span class="s1">$ deg&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;S21 Phase (deg)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>From the simulation data, we can see that this parallel-plate waveguide’s
insertion loss is anomalously high, around 20 dB at 2 GHz.
This behavior contradicts expectations, as both lumped capacitors and
transmission lines are typically lossless.
Unusual results like
this one may indicate a modeling mistake that either causes unphysical
behavior or the excitation of theoretical but unrealistic physical effects.
Alternatively, it may reveal actual physics rarely discussed in circuit
textbooks, so it can be “new” to us. We will discuss this issue later.</p>
<p>On the other hand, the phase angle runs between -180° and 180°. This is
the expected behavior consistent with real-world measurements.</p>
<a class="reference internal image-reference" href="../../../_images/s21_db_sim.svg"><img alt="../../../_images/s21_db_sim.svg" src="../../../_images/s21_db_sim.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/s21_deg_sim.svg"><img alt="../../../_images/s21_deg_sim.svg" src="../../../_images/s21_deg_sim.svg" width="49%" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Loss or Gain?</strong>
There’s a technicality to nitpick. The term “loss” and “gain” are often
used interchangeably in the RF/microwave industry. One may say a device
has a return loss of -20 dB, but strictly speaking a negative loss implies
a gain. This convention is technically incorrect but usually tolerated and
widely used. On the other hand, its critics insist on inverting the sign
(by multiplying all values by a factor of -1) when one is speaking of “loss”.
Otherwise, the proper term to seak of is “reflection coefficient”, not
“return loss”.</p>
<p>This issue can sometimes be quite controversial. For example, <em>IEEE Antennas
and Propagation Magazine</em> started rejecting the former convention to promote
rigor as of 2009. While the author of this tutorial has no particular opinion,
to satisfy the potential nitpickers while following the tradition, here we use
a compromise. Plots are labeled as “Return loss” and use the positive sign
convention, but also with the Y axis inverted, so that resonances appear
as familiar valleys.</p>
<p>For more information, see <a class="footnote-reference brackets" href="#id13" id="id3">1</a> <a class="footnote-reference brackets" href="#id14" id="id4">2</a>.</p>
</div>
</section>
<section id="plot-z-parameters-impedances-via-matplotlib">
<h3>Plot Z-parameters (Impedances) via matplotlib<a class="headerlink" href="#plot-z-parameters-impedances-via-matplotlib" title="Permalink to this headline"></a></h3>
<p>It’s trivial to transform S-parameters to Z-parameters (impedances) using
well-known formulas, so a separate calculation is not necessary.
If <span class="math notranslate nohighlight">\(Z0\)</span> is the port impedance, <span class="math notranslate nohighlight">\(S_{11}\)</span> (also known as the
reflection coefficient <span class="math notranslate nohighlight">\(\Gamma\)</span>) is related to the DUT impedance
via:</p>
<div class="math notranslate nohighlight">
\[Z = Z_0 \frac{1 + \Gamma }{1 - \Gamma}\]</div>
<p>Nevetheless, directly calculating the impedance seen by a port via the total
voltage <code class="docutils literal notranslate"><span class="pre">uf_tot</span></code> and total current <code class="docutils literal notranslate"><span class="pre">if_tot</span></code> attributes of the port object.
The following example plot the impedance seen by port 1. Like S-parameters,
all impedances are also complex numbers, so we are only looking at its
magnitude (absolute value) here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># direct impedance calculation</span>
<span class="n">z11_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_tot</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">if_tot</span><span class="p">)</span>

<span class="c1"># derive impedance from S11</span>
<span class="n">z11_from_s11_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s11_list</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s11_list</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">z11_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$|Z_</span><span class="si">{11}</span><span class="s1">|$ (Ω)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">z11_from_s11_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$|Z_</span><span class="si">{11}</span><span class="s1">|$ (Ω)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Impedance Magnitude (Ω)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>We find that the impedances derived from <span class="math notranslate nohighlight">\(S_{11}\)</span> and from direct calculations
are indistinguishable.</p>
<a class="reference internal image-reference" href="../../../_images/z11_mag_sim.svg"><img alt="../../../_images/z11_mag_sim.svg" src="../../../_images/z11_mag_sim.svg" width="49%" /></a>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We shall repeat the warning that was already given in the <a class="reference internal" href="#port"><span class="std std-ref">Purpose of Ports</span></a>
section. Beware that the impedance <span class="math notranslate nohighlight">\(Z_{11}\)</span> is not the actual impedance
of the DUT, such as this parallel-plate waveguide. It’s only the impedance seen
by the port, affected by the same factors that would affect <span class="math notranslate nohighlight">\(S_{11}\)</span>,
such as port mismatches, test fixture reflections, imperfect terminations and
other factors, creating frequency-dependent artifacts. The DUT impedance can’t
be read from <span class="math notranslate nohighlight">\(Z_{11}\)</span> without solving this problem by eliminating
discontinuities or separating the contributions from both parts via
de-embedding, calibration, or time gating. These are advanced topics not
discussed here.</p>
</div>
</section>
<section id="code-checkpoint-2-eliminate-repetitions-in-matplotlib-code">
<h3>Code Checkpoint 2: Eliminate Repetitions in <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> Code<a class="headerlink" href="#code-checkpoint-2-eliminate-repetitions-in-matplotlib-code" title="Permalink to this headline"></a></h3>
<p>The matplotlib examples shown above are meant to be instructional. In
an actual program, we should avoid unproductive repetitions when we see
them. We can write a separate plotting function to avoid repeating the
same steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_param</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span><span class="p">,</span> <span class="n">linelabel</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">invert_y</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">linelabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="c1"># By convention, loss values increases downward on the Y axis.</span>
    <span class="c1"># This is consistent with the plot shapes on spectrum analyzers, and</span>
    <span class="c1"># perhaps explains why the customary &quot;wrong&quot; sign convention is used.</span>
    <span class="k">if</span> <span class="n">invert_y</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">postproc</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the data generated by a complete simulation. Only knowledge of ports</span>
<span class="sd">    are necessary. This function is agnostic about the structure and simulator</span>
<span class="sd">    parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">CalcPort</span><span class="p">(</span><span class="n">simdir</span><span class="p">,</span> <span class="n">freq_list</span><span class="p">,</span> <span class="n">ref_impedance</span><span class="o">=</span><span class="n">z0</span><span class="p">)</span>

    <span class="n">s11_list</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_ref</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_inc</span>
    <span class="n">s21_list</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uf_ref</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_inc</span>

    <span class="c1"># hack: assume symmetry and reciprocity, only correct for passive linear circuit!</span>
    <span class="n">s22_list</span> <span class="o">=</span> <span class="n">s11_list</span>
    <span class="n">s12_list</span> <span class="o">=</span> <span class="n">s21_list</span>

    <span class="n">s11_db_list</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s11_list</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">s21_db_list</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s21_list</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s11_db_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{11}</span><span class="s1">$ dB&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;Return Loss (dB)&#39;</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s21_db_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{21}</span><span class="s1">$ dB&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;Insertion Loss (dB)&#39;</span><span class="p">)</span>

    <span class="n">s11_deg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s11_list</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s21_deg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s21_list</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s11_deg_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{11}</span><span class="s1">$ deg&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;S11 Phase&#39;</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s21_deg_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{21}</span><span class="s1">$ deg&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;S21 Phase&#39;</span><span class="p">)</span>

    <span class="c1"># direct impedance calculation</span>
    <span class="n">z11_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_tot</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">if_tot</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">z11_list</span><span class="p">,</span> <span class="s1">&#39;$|Z_</span><span class="si">{11}</span><span class="s1">|$ (Ω)&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;Impedance Magnitude (Ω)&#39;</span><span class="p">,</span> <span class="n">invert_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="plot-time-domain-waveforms-via-matplotlib">
<h3>Plot Time-Domain Waveforms via matplotlib<a class="headerlink" href="#plot-time-domain-waveforms-via-matplotlib" title="Permalink to this headline"></a></h3>
<p>FDTD is fundamentally a time-domain field solver. In some cases it’s
desirable to create custom excitations and observe transient resposes
directly. For example, it allows one to truncate a simulation early
without waiting for convergence. It may help avoiding violations of
passivity and causality in S-parameters due to numerical artifacts,
which is problematic in some transient simulations.</p>
<p>To obtain the time-domain waveforms at a port, we can use these port
attributes: <code class="docutils literal notranslate"><span class="pre">u_data.ut_tot</span></code> total voltage), <code class="docutils literal notranslate"><span class="pre">u_data.ui_time[0]</span></code> (time
of voltage samples), <code class="docutils literal notranslate"><span class="pre">i_data.it_tot</span></code> (total current), <code class="docutils literal notranslate"><span class="pre">i_data.ui_time[0]</span></code>
(time of current samples).</p>
<p>For the first try, let’s plot the voltages at port 1 and port 2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">u_data</span><span class="o">.</span><span class="n">ui_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ut_tot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input Voltage&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">u_data</span><span class="o">.</span><span class="n">ui_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ut_tot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Output Voltage&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The excitation signal is a sinusoid at the center frequency, with its amplitude
modulated by a Gaussian function. This is difficult to make sense of, since the
Gaussian function decays rapidly but the simulator keeps running until all energy
has decayed below 60 dB, so the waveform is a spike followed by a flatline near 0.</p>
<a class="reference internal image-reference" href="../../../_images/port1_vt.svg"><img alt="../../../_images/port1_vt.svg" src="../../../_images/port1_vt.svg" width="49%" /></a>
<p>Let’s try again, focusing only on the first 100 samples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">u_data</span><span class="o">.</span><span class="n">ui_time</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ut_tot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input Voltage&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">u_data</span><span class="o">.</span><span class="n">ui_time</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ut_tot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Output Voltage&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>This is much better. The Gaussian modulation of the input signal is
clearly visible. There’s also a noticeable time delay before it reaches
the output, with an attenuation by one or two orders of magnitude. Both
are expected.</p>
<a class="reference internal image-reference" href="../../../_images/port1_vt_early.svg"><img alt="../../../_images/port1_vt_early.svg" src="../../../_images/port1_vt_early.svg" width="49%" /></a>
<p>Time-domain usage of openEMS is best-suited with custom excitation signals.
For example, one use case is to study the Time-Domain Transmission and
Time-Domain Reflection (TDT/TDR) characteristics of the DUT directly in time
domain, which is out of the scope of this tutorial. Hence, this tutorial
advocates for relying on mature frequency-domain analysis tools based on
S-parameters (which are possible to use in time-domain transient simulations
as well), as FDTD typically uses wideband Gaussian excitation signals that
are difficult to interpret in the time domain anyway.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The raw time-domain voltages and currents at all ports are also available
in the simulation directory as <code class="docutils literal notranslate"><span class="pre">port_ut_1</span></code>, <code class="docutils literal notranslate"><span class="pre">port_ut_2</span></code>, <code class="docutils literal notranslate"><span class="pre">port_it_1</span></code>
and <code class="docutils literal notranslate"><span class="pre">port_it_2</span></code>, which can be used by external programs.</p>
</div>
</section>
<section id="export-s-parameters-to-touchstone">
<h3>Export S-parameters to Touchstone<a class="headerlink" href="#export-s-parameters-to-touchstone" title="Permalink to this headline"></a></h3>
<p>At this point, we have nearly reached the limit of the built-in
post-processing capabilities of openEMS.
To bring our analysis futher, it’s now necessary to use third-party
software. Therefore we must save our S-parameters to an external file
to use them in other tools. In the RF/microwave industry, S-parameters
are encoded in a de-facto standard file format called a <em>Touchstone</em>
file.</p>
<p>A 2-port Touchstone file has the file extension <code class="docutils literal notranslate"><span class="pre">.s2p</span></code>, the first line
is its metadata.</p>
<p>The hash (<code class="docutils literal notranslate"><span class="pre">#</span></code>) symbol denotes a metadata line, not a comment line,
this line is not optional (the real comment line begins with <code class="docutils literal notranslate"><span class="pre">!</span></code>).
Letter <code class="docutils literal notranslate"><span class="pre">S</span></code> letter means the file contains S-parameters, keyword
<code class="docutils literal notranslate"><span class="pre">RI</span></code> means the complex S-parameters are in the real-imaginary format,
and the final <code class="docutils literal notranslate"><span class="pre">R</span> <span class="pre">50</span></code> means the port impedance for this measurement
is 50 Ω:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hz S RI R 50</span>
</pre></div>
</div>
<section id="s2p-file">
<h4><code class="docutils literal notranslate"><span class="pre">.s2p</span></code> file<a class="headerlink" href="#s2p-file" title="Permalink to this headline"></a></h4>
<p>In an <code class="docutils literal notranslate"><span class="pre">.s2p</span></code> file, the following lines define the S-parameters at each frequency
point, with the
order of <code class="docutils literal notranslate"><span class="pre">frequency</span></code>, <code class="docutils literal notranslate"><span class="pre">s11_real</span></code>, <code class="docutils literal notranslate"><span class="pre">s11_imag</span></code>, <code class="docutils literal notranslate"><span class="pre">s21_real</span></code>, <code class="docutils literal notranslate"><span class="pre">s21_imag</span></code>, <code class="docutils literal notranslate"><span class="pre">s12_real</span></code>,
<code class="docutils literal notranslate"><span class="pre">s12_imag</span></code>, <code class="docutils literal notranslate"><span class="pre">s22_real</span></code>, <code class="docutils literal notranslate"><span class="pre">s22_imag</span></code>.  All variables are floating-point numbers.</p>
<p>Thus we can write the simulation result as a Touchstone file using the following
code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># determine a file name</span>
<span class="n">s2pname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.s2p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># concat path</span>
<span class="n">s2ppath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">s2pname</span>

<span class="c1"># write 2-port S-parameters</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">s2ppath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">touchstone</span><span class="p">:</span>
    <span class="n">touchstone</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Hz S RI R </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">z0</span><span class="p">)</span>  <span class="c1"># Touchstone metadata, not comment!</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq_list</span><span class="p">):</span>
        <span class="n">s11</span> <span class="o">=</span> <span class="n">s11_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">s21</span> <span class="o">=</span> <span class="n">s21_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">s12</span> <span class="o">=</span> <span class="n">s12_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">s22</span> <span class="o">=</span> <span class="n">s22_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">s11</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s11</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">s21</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s21</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">s12</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s12</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">s22</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s22</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        <span class="n">touchstone</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s1p-file">
<h4><code class="docutils literal notranslate"><span class="pre">.s1p</span></code> file<a class="headerlink" href="#s1p-file" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">.s2p</span></code> file already contains the S-parameter <span class="math notranslate nohighlight">\(S_{11}\)</span>, so
there’s no need to create a separate 1-port Touchstone file. But for
completeness, the Touchstone file for 1-port measurements has the
suffix <code class="docutils literal notranslate"><span class="pre">.s1p</span></code>. Its format is similar: at each frequency point, one
writes a new line with parameters order of <code class="docutils literal notranslate"><span class="pre">frequency</span></code>, <code class="docutils literal notranslate"><span class="pre">s11_real</span></code>,
<code class="docutils literal notranslate"><span class="pre">s11_imag</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># determine a file name</span>
<span class="n">s1pname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.s1p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># concat path</span>
<span class="n">s1ppath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">s1pname</span>

<span class="c1"># write 1-port S-parameters</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">s1ppath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">touchstone</span><span class="p">:</span>
    <span class="n">touchstone</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Hz S RI R </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">z0</span><span class="p">)</span>  <span class="c1"># Touchstone metadata, not comment!</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq_list</span><span class="p">):</span>
        <span class="n">s11</span> <span class="o">=</span> <span class="n">s11_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">s11</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s11</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        <span class="n">touchstone</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="snp-file">
<h4><code class="docutils literal notranslate"><span class="pre">.snp</span></code> file<a class="headerlink" href="#snp-file" title="Permalink to this headline"></a></h4>
<p>Finally, beware that for 3-port, 4-port, or more ports, the parameters order is
different. The website Microwaves101 contains useful information here. <a class="footnote-reference brackets" href="#id15" id="id5">3</a></p>
</section>
</section>
</section>
<section id="code-checkpoint-3">
<h2>Code Checkpoint 3<a class="headerlink" href="#code-checkpoint-3" title="Permalink to this headline"></a></h2>
<p>As a checkpoint of our progress, the following is the complete code one
obtains if the previous instructions are followed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">CSXCAD</span>
<span class="kn">import</span> <span class="nn">openEMS</span>
<span class="kn">from</span> <span class="nn">openEMS.physical_constants</span> <span class="kn">import</span> <span class="n">C0</span>

<span class="c1"># calculate mesh resolution according to simulation frequency</span>
<span class="n">unit</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="mf">10e9</span>
<span class="n">epsilon_r</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon_r</span><span class="p">)</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">f_max</span> <span class="o">/</span> <span class="n">unit</span>  <span class="c1"># convert to millimeters</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="mi">10</span>

<span class="c1"># calculate frequency points</span>
<span class="n">points</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">freq_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">100e6</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>

<span class="c1"># port impedance</span>
<span class="n">z0</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># determine the simulation output path</span>

<span class="c1"># find the directory of the script itself</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="c1"># use a directory named after the script, but without &quot;.py&quot;</span>
<span class="n">simdir</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">simdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># find the filename of the script itself, and replace &quot;.py&quot; with &quot;.xml&quot;</span>
<span class="n">xmlname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># concat path</span>
<span class="n">xmlpath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">xmlname</span>


<span class="k">def</span> <span class="nf">generate_structure</span><span class="p">(</span><span class="n">csx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate and return the 3D structure used for simulation.</span>

<span class="sd">    This function should return a CSXCAD instance, but without changing any</span>
<span class="sd">    simulation parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set unit of measurement in the CSXCAD drawing</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">GetGrid</span><span class="p">()</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">SetDeltaUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>

    <span class="c1"># Create an instance of material named &quot;plate&quot;.</span>
    <span class="c1"># AddMetal() creates a Perfect Electric Conductor.</span>
    <span class="n">metal</span> <span class="o">=</span> <span class="n">csx</span><span class="o">.</span><span class="n">AddMetal</span><span class="p">(</span><span class="s1">&#39;plate&#39;</span><span class="p">)</span>

    <span class="c1"># Build two 3D shapes from -50 to 50 on the X/Y axes, located at Z = -8</span>
    <span class="c1"># and Z = 8 respectively. Note that the starting and stopping Z coordinates</span>
    <span class="c1"># of each plate are the same, so these metal plates have zero thickness.</span>
    <span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># lower plate</span>
    <span class="n">metal</span><span class="o">.</span><span class="n">AddBox</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">8</span><span class="p">])</span>  <span class="c1"># upper plate</span>

    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>  <span class="c1"># two lines at -100, 100</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span>   <span class="mi">50</span><span class="p">])</span>  <span class="c1"># two lines at -50, 50</span>

    <span class="c1"># strategically draw lines misaligned with the waveguide&#39;s left and right edges,</span>
    <span class="c1"># so that the edge occupies a cell by 33%.</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the X axis</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># apply 1/3-2/3 rule on the Y axis</span>

    <span class="c1"># zero-thickness metal plates need mesh lines at their exact levels</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>    <span class="c1"># two lines at -8, 8</span>

    <span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">SmoothMeshLines</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">csx</span>


<span class="k">def</span> <span class="nf">setup_ports</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and return ports to inject and measure signals at a particular mesh</span>
<span class="sd">    location.</span>

<span class="sd">    This function should only create ports, but without changing the structure</span>
<span class="sd">    or simulation parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">port</span>


<span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup boundary conditions, excitation signals, and finally run the</span>
<span class="sd">    simulator.</span>

<span class="sd">    This function should run the simulator from the given &quot;fdtd&quot; and &quot;csx&quot;</span>
<span class="sd">    instance, without changing them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Centered around 5 GHz with a 5 GHz 20 dB bandwidth.</span>
    <span class="c1"># Lower sideband covers 0 - 5 GHz, upper sideband cover 5 - 10 GHz.</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">SetGaussExcite</span><span class="p">(</span><span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">SetBoundaryCond</span><span class="p">([</span><span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">,</span> <span class="s2">&quot;PML_8&quot;</span><span class="p">])</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">simdir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">postproc</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the data generated by a complete simulation. Only knowledge of ports</span>
<span class="sd">    are necessary. This function is agnostic about the structure and simulator</span>
<span class="sd">    parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">CalcPort</span><span class="p">(</span><span class="n">simdir</span><span class="p">,</span> <span class="n">freq_list</span><span class="p">,</span> <span class="n">ref_impedance</span><span class="o">=</span><span class="n">z0</span><span class="p">)</span>

    <span class="n">s11_list</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_ref</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_inc</span>
    <span class="n">s21_list</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uf_ref</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_inc</span>

    <span class="c1"># hack: assume symmetry and reciprocity, only correct for passive linear circuit!</span>
    <span class="n">s22_list</span> <span class="o">=</span> <span class="n">s11_list</span>
    <span class="n">s12_list</span> <span class="o">=</span> <span class="n">s21_list</span>

    <span class="n">s11_db_list</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s11_list</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">s21_db_list</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s21_list</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s11_db_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{11}</span><span class="s1">$ dB&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;Return Loss (dB)&#39;</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s21_db_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{21}</span><span class="s1">$ dB&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;Insertion Loss (dB)&#39;</span><span class="p">)</span>

    <span class="n">s11_deg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s11_list</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s21_deg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s21_list</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s11_deg_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{11}</span><span class="s1">$ deg&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;S11 Phase&#39;</span><span class="p">)</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">s21_deg_list</span><span class="p">,</span> <span class="s1">&#39;$S_</span><span class="si">{21}</span><span class="s1">$ deg&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;S21 Phase&#39;</span><span class="p">)</span>

    <span class="n">z11_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uf_tot</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">if_tot</span><span class="p">)</span>  <span class="c1"># direct impedance calculation</span>
    <span class="n">plot_param</span><span class="p">(</span><span class="n">freq_list</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">z11_list</span><span class="p">,</span> <span class="s1">&#39;$|Z_</span><span class="si">{11}</span><span class="s1">|$ (Ω)&#39;</span><span class="p">,</span> <span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="s1">&#39;Impedance Magnitude (Ω)&#39;</span><span class="p">,</span> <span class="n">invert_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">u_data</span><span class="o">.</span><span class="n">ui_time</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ut_tot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Input Voltage&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">u_data</span><span class="o">.</span><span class="n">ui_time</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ut_tot</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Output Voltage&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">save_s2p</span><span class="p">(</span><span class="n">s11_list</span><span class="p">,</span> <span class="n">s21_list</span><span class="p">,</span> <span class="n">s12_list</span><span class="p">,</span> <span class="n">s22_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_param</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span><span class="p">,</span> <span class="n">linelabel</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">invert_y</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">linelabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="c1"># By convention, loss values increases downward on the Y axis.</span>
    <span class="c1"># This is consistent with the plot shapes on spectrum analyzers, and</span>
    <span class="c1"># perhaps explains why the customary &quot;wrong&quot; sign convention is used.</span>
    <span class="k">if</span> <span class="n">invert_y</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">save_s2p</span><span class="p">(</span><span class="n">s11_list</span><span class="p">,</span> <span class="n">s21_list</span><span class="p">,</span> <span class="n">s12_list</span><span class="p">,</span> <span class="n">s22_list</span><span class="p">):</span>
    <span class="c1"># determine a file name</span>
    <span class="n">s2pname</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.s2p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># concat path</span>
    <span class="n">s2ppath</span> <span class="o">=</span> <span class="n">simdir</span> <span class="o">/</span> <span class="n">s2pname</span>

    <span class="c1"># write 2-port S-parameters</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">s2ppath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">touchstone</span><span class="p">:</span>
        <span class="n">touchstone</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Hz S RI R </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">z0</span><span class="p">)</span>  <span class="c1"># Touchstone metadata, not comment!</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq_list</span><span class="p">):</span>
            <span class="n">s11</span> <span class="o">=</span> <span class="n">s11_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">s21</span> <span class="o">=</span> <span class="n">s21_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">s12</span> <span class="o">=</span> <span class="n">s12_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">s22</span> <span class="o">=</span> <span class="n">s22_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">s11</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s11</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">s21</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s21</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">s12</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s12</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">s22</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">s22</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
            <span class="n">touchstone</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">csx</span> <span class="o">=</span> <span class="n">CSXCAD</span><span class="o">.</span><span class="n">ContinuousStructure</span><span class="p">()</span>
    <span class="n">fdtd</span> <span class="o">=</span> <span class="n">openEMS</span><span class="o">.</span><span class="n">openEMS</span><span class="p">()</span>

    <span class="c1"># associate CSXCAD structure with an openEMS simulation</span>
    <span class="n">fdtd</span><span class="o">.</span><span class="n">SetCSX</span><span class="p">(</span><span class="n">csx</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No command given, expect &quot;generate&quot;, &quot;simulate&quot;, &quot;postproc&quot;&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;generate&quot;</span><span class="p">,</span> <span class="s2">&quot;simulate&quot;</span><span class="p">]:</span>
        <span class="c1"># generate 3D structure</span>
        <span class="n">generate_structure</span><span class="p">(</span><span class="n">csx</span><span class="p">)</span>
        <span class="n">setup_ports</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">)</span>
        <span class="n">csx</span><span class="o">.</span><span class="n">Write2XML</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xmlpath</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simulate&quot;</span><span class="p">:</span>
            <span class="c1"># run simulator</span>
            <span class="n">simulate</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;postproc&quot;</span><span class="p">:</span>
        <span class="c1"># run post-processing only, without running the simulator</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">setup_ports</span><span class="p">(</span><span class="n">fdtd</span><span class="p">,</span> <span class="n">csx</span><span class="p">)</span>
        <span class="n">postproc</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown command </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="third-party-post-processing">
<h2>Third-Party Post-Processing<a class="headerlink" href="#third-party-post-processing" title="Permalink to this headline"></a></h2>
<p>At this point, we have nearly reached the limit of the built-in
post-processing capabilities of openEMS. The only three post-processing
features we haven’t used are Near-Field to Far-Field Transformation
(NF2FF) for antenna analysis, and Specific Absorption Rate (SAR)
analysis, but both are irrelevant for this simulation.</p>
<p>To bring our analysis futher, it’s now necessary to use third-party
software with the S-parameters we’ve saved.</p>
<section id="s-parameters-analysis-via-scikit-rf">
<h3>S-parameters Analysis via <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code><a class="headerlink" href="#s-parameters-analysis-via-scikit-rf" title="Permalink to this headline"></a></h3>
<p>The library <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> is an open source Python package for RF/microwave
engineering, including a powerful set of features for plotting, circuit
analysis, calibration, reading and writing data.</p>
<section id="install-and-import">
<h4>Install and Import<a class="headerlink" href="#install-and-import" title="Permalink to this headline"></a></h4>
<p>One can install it via <code class="docutils literal notranslate"><span class="pre">pip3</span></code> to your home directory (or another <code class="docutils literal notranslate"><span class="pre">venv</span></code>
environment you prefer):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip3</span> <span class="n">install</span> <span class="n">scikit</span><span class="o">-</span><span class="n">rf</span> <span class="o">--</span><span class="n">user</span>
</pre></div>
</div>
<p>Once installed, import the library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">skrf</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> comes with a matplotlib chart theme with a modern look-and-feel.
Before using the library to do anything, one may call <cite>stylely()</cite> to
globally apply this theme. This affects all matplotlib charts, so you may
want to borrow it in other unrelated projects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">skrf</span><span class="o">.</span><span class="n">stylely</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="plot-smith-charts">
<h4>Plot Smith Charts<a class="headerlink" href="#plot-smith-charts" title="Permalink to this headline"></a></h4>
<p>The basic entity in <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> is a <code class="docutils literal notranslate"><span class="pre">skrf.Network</span></code>, representing an
n-port network defined by an S-parameter. This object can be constructed
directly via the path to a Touchstone file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span> <span class="o">=</span> <span class="n">skrf</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">s2ppath</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s plot the complex reflections coefficient <span class="math notranslate nohighlight">\(S_{11}\)</span> on
the Smith chart, the most important chart ever invented in RF/microwave
engineering. This chart makes it easier to interpret the phase angle in
the reflection coefficient and impedance by visually showing whether the
the DUT is resistive, capacitive, or inductive. To do so in <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code>,
use the <cite>plot_s_smith()</cite> method of the <cite>Network</cite> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_s_smith</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>By default, all S-parameters are plotted.</p>
<img alt="../../../_images/s_all_smith_sim.svg" src="../../../_images/s_all_smith_sim.svg" /><p>But it makes little sense to plot non-reflection parameters, so we specify
two optional parameters <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">n</span></code>. To plot <span class="math notranslate nohighlight">\(S_{11}\)</span> only, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_s_smith</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>As we can see from the chart, the input impedence of the DUT is inductive.
This is likely due to the mismatches of both the electrical impedance
and the physical geometry of the excitation and termination ports at the
abrupt transition from the port to the waveguide.</p>
<img alt="../../../_images/s11_smith_sim.svg" src="../../../_images/s11_smith_sim.svg" /><p>An alternative way to plot <span class="math notranslate nohighlight">\(S_{11}\)</span> is to slice a multi-port network
to obtain a 1-port network using the <code class="docutils literal notranslate"><span class="pre">s11</span></code> attribute (or <code class="docutils literal notranslate"><span class="pre">s21</span></code>, <code class="docutils literal notranslate"><span class="pre">s22</span></code>,
etc). But note that doing would create a new 1-port network, so all
charts will be labeled <code class="docutils literal notranslate"><span class="pre">S11</span></code> regardless of the parameter plotted.
Hence plotting a sliced network is not recommended:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">s11</span><span class="o">.</span><span class="n">plot_s_smith</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="plot-magnitude-phase-charts">
<h4>Plot Magnitude-Phase Charts<a class="headerlink" href="#plot-magnitude-phase-charts" title="Permalink to this headline"></a></h4>
<p>We can also plot other familiar charts via <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> automatically, such
as the scalar <span class="math notranslate nohighlight">\(S_{11}\)</span> plot in decibles and phase angles. This is
much faster than the manual method using only two lines of code for each chart:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_s_db</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">network</span><span class="o">.</span><span class="n">plot_s_deg</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The data is identical to manual plotting, but without the need to do any
calculations. All is derived from S-parameters by scikit-rf automatically.</p>
<a class="reference internal image-reference" href="../../../_images/s11_db_sim_skrf.svg"><img alt="../../../_images/s11_db_sim_skrf.svg" src="../../../_images/s11_db_sim_skrf.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/s11_deg_sim_skrf.svg"><img alt="../../../_images/s11_deg_sim_skrf.svg" src="../../../_images/s11_deg_sim_skrf.svg" width="49%" /></a>
<p>Likewise, to plot <span class="math notranslate nohighlight">\(S_{21}\)</span>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_s_db</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">network</span><span class="o">.</span><span class="n">plot_s_deg</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../_images/s21_db_sim_skrf.svg"><img alt="../../../_images/s21_db_sim_skrf.svg" src="../../../_images/s21_db_sim_skrf.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/s21_deg_sim_skrf.svg"><img alt="../../../_images/s21_deg_sim_skrf.svg" src="../../../_images/s21_deg_sim_skrf.svg" width="49%" /></a>
</section>
<section id="plot-impedance-chart">
<h4>Plot Impedance Chart<a class="headerlink" href="#plot-impedance-chart" title="Permalink to this headline"></a></h4>
<p><cite>scikit-rf</cite> also provides several routines to Z-parameters charts, such
as the scalar impedance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="o">.</span><span class="n">plot_z_mag</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../../_images/z11_mag_sim_skrf.svg"><img alt="../../../_images/z11_mag_sim_skrf.svg" src="../../../_images/z11_mag_sim_skrf.svg" width="49%" /></a>
</section>
<section id="time-domain-reflectometry">
<h4>Time Domain Reflectometry<a class="headerlink" href="#time-domain-reflectometry" title="Permalink to this headline"></a></h4>
<p>And now for something completely different: going from the frequency
domain back to the time domain. By an inverse Fourier transform on
the existing S-parameters (without running new FDTD simulations),
<code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> can directly calculate the DUT’s equivalent transient
impulse and step impedance from <span class="math notranslate nohighlight">\(S_{11}\)</span>. This enables capturing
impedance discontinuities that are difficult if not impossible to
identify using the Smith chart alone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># TDR requires the DC component to be physical</span>
<span class="n">network_dc</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">extrapolate_to_dc</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time Domain Reflectometry - Step&quot;</span><span class="p">)</span>
<span class="n">network_dc</span><span class="o">.</span><span class="n">s11</span><span class="o">.</span><span class="n">plot_z_time_step</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;impedance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># look at the first two nanoseconds</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time Domain Reflectometry - Impulse&quot;</span><span class="p">)</span>
<span class="n">network_dc</span><span class="o">.</span><span class="n">s11</span><span class="o">.</span><span class="n">plot_z_time_impulse</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;impedance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># look at the first two nanoseconds</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The calculated TDR plot with step excitation shows a strong reflection
at an instantaneous impedance of 140 Ω, followed by another reflection
of 70 Ω one nanoseconds later (the impulse excitation TDR plot is also
included here for completeness).</p>
<a class="reference internal image-reference" href="../../../_images/tdr_step_sim.svg"><img alt="../../../_images/tdr_step_sim.svg" src="../../../_images/tdr_step_sim.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/tdr_impulse_sim.svg"><img alt="../../../_images/tdr_impulse_sim.svg" src="../../../_images/tdr_impulse_sim.svg" width="49%" /></a>
<p>This clearly indicates both ports exhibit discontinuities due to
impedance and geometry mismatches, as the lumped port impedance
differs from waveguide’s characteristic impedance.</p>
<p>In transmission line characterization, one should address such
mismatches by improving the simulation setup via better port
transitions, or through post-processing techniques like de-embedding
or time-gating. However, in this simulation, the mismatches are
intentionally introduced to demonstrate openEMS’s ability to
accurately model real-world effects.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>TODO: instruct users to view <code class="docutils literal notranslate"><span class="pre">scikit-rf</span></code> documentation.</p>
</div>
</section>
</section>
<section id="transient-analysis-via-signalintegrity">
<h3>Transient Analysis via <code class="docutils literal notranslate"><span class="pre">SignalIntegrity</span></code><a class="headerlink" href="#transient-analysis-via-signalintegrity" title="Permalink to this headline"></a></h3>
<p>This tutorial has repeatedly claimed that the frequency response
is all you need: Once the DUT’s S-parameters are known, linear
circuit analysis tools can evaluate its behavior under other
input signals, so there’s no loss of generality. In fact, performing
a time-domain transient simulation using frequency-domain S-parameters
is a common feature in many proprietary commercial circuit simulators,
such as <strong class="program">HyperLynx</strong>, <strong class="program">ADS</strong>, or <strong class="program">AWR</strong>. A
third-party tool also exists for PSpice. <a class="footnote-reference brackets" href="#id16" id="id6">4</a></p>
<p>However, in the free and open source world, few (if any) free and
open source circuit simulator have this capability. For example,
NgSPICE supports S-parameter calculation but not transient
simulation. <a class="footnote-reference brackets" href="#id17" id="id7">5</a> <strong class="program">Qucs</strong>, too, doesn’t support transient
simulation with S-parameters, although it’s possible to define
devices using them.</p>
<p>The Python package <strong class="program">SignalIntegrity</strong>, designed for signal
integrity and eye diagram simulations from the ground up, is a rare
exception.  It’s designed by Pete Pupalaikis, who previously worked
at LeCroy as a signal integrity expert.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>The software’s internal theory of operation is also published almost
in full in the textbook <em>S-Parameters for Signal Integrity</em> <a class="footnote-reference brackets" href="#id18" id="id8">6</a>. Each
concept is accomplished by both formulas and executable code, making
it an invaluable reference in this field. The author of this tutorial
recommends everyone who simulates or measures RF/microwave devices to
get a copy.</p>
</div>
<section id="install">
<h4>Install<a class="headerlink" href="#install" title="Permalink to this headline"></a></h4>
<p>To install <code class="docutils literal notranslate"><span class="pre">SignalIntegrity</span></code>, download the latest <code class="docutils literal notranslate"><span class="pre">.zip</span></code> file
at the project’s release page using a Web browser:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Nubis</span><span class="o">-</span><span class="n">Communications</span><span class="o">/</span><span class="n">SignalIntegrity</span><span class="o">/</span><span class="n">releases</span>
</pre></div>
</div>
<p>As of writing, the latest version was 1.4.1. Once downloaded, unzip
the file and install it locally via <strong class="program">pip</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unzip</span> <span class="n">SignalIntegrity</span><span class="o">-</span><span class="mf">1.4.1</span><span class="o">.</span><span class="n">zip</span>
<span class="n">cd</span> <span class="n">SignalIntegrity</span><span class="o">-</span><span class="mf">1.4.1</span>

<span class="n">pip3</span> <span class="n">install</span> <span class="o">.</span> <span class="o">--</span><span class="n">user</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SignalIntegrity</span></code> is both a software library and a Tcl/Tk (Tkinter)
GUI application, installed to <code class="docutils literal notranslate"><span class="pre">~/.local/bin/</span></code> (or another standard
local path). You should be able to start it via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ SignalIntegrity
</pre></div>
</div>
<p>If not, you may need to add this local <code class="file docutils literal notranslate"><span class="pre">bin</span></code> directory into
your shell’s search path.</p>
<figure class="align-default" id="id30">
<a class="with-border reference internal image-reference" href="../../../_images/si1.png"><img alt="../../../_images/si1.png" class="with-border" src="../../../_images/si1.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-text">The classic 1990s Tcl/Tk (Tkinter) GUI may look old-fashioned,
but it works, and will keep working until the end of time.</span><a class="headerlink" href="#id30" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="impulse-signal-analysis">
<h4>Impulse Signal Analysis<a class="headerlink" href="#impulse-signal-analysis" title="Permalink to this headline"></a></h4>
<p>For the first example, let’s examine the circuit’s time-domain
response to a short impulse.</p>
<p><strong>Add an S-parameter defined 2-port network.</strong> Right click on the
empty schematic, choose <span class="guilabel">Add Part</span>. In the <span class="guilabel">Add
Part</span> diagram, click <span class="menuselection">Files ‣ Two Port File</span>. In
the opened setting window, click
<span class="guilabel">browse</span> and select the <code class="docutils literal notranslate"><span class="pre">s2p</span></code> S-parameter file created
by our simulation. Click <span class="guilabel">OK</span>, and finally click the empty
schematic to place the item. The item can be moved by selecting it
and dragging it.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_1.png"><img alt="../../../_images/transient_sim_1.png" src="../../../_images/transient_sim_1.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_2.png"><img alt="../../../_images/transient_sim_2.png" src="../../../_images/transient_sim_2.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_3.png"><img alt="../../../_images/transient_sim_3.png" src="../../../_images/transient_sim_3.png" style="width: 30%;" /></a>
<p><strong>Add a voltage pulse generator.</strong> In the <span class="guilabel">Add Part</span> dialog,
choose <span class="menuselection">Generators ‣ One Port Voltage Pulse Generators</span>.
In the opened setting window, change the <span class="guilabel">risetime (s)</span> property
to “100 ps”, and place this item on the schematic.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_4.png"><img alt="../../../_images/transient_sim_4.png" src="../../../_images/transient_sim_4.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_5.png"><img alt="../../../_images/transient_sim_5.png" src="../../../_images/transient_sim_5.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_21.png"><img alt="../../../_images/transient_sim_21.png" src="../../../_images/transient_sim_21.png" style="width: 30%;" /></a>
<p><strong>Add a series resistor to represent the generator’s output impedance.</strong>
In the <span class="guilabel">Add Part</span> dialog, choose <span class="menuselection">Resistors ‣ Two
Port Resistor</span>. Place this item on the schematic.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_6.png"><img alt="../../../_images/transient_sim_6.png" src="../../../_images/transient_sim_6.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_7.png"><img alt="../../../_images/transient_sim_7.png" src="../../../_images/transient_sim_7.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_8.png"><img alt="../../../_images/transient_sim_8.png" src="../../../_images/transient_sim_8.png" style="width: 30%;" /></a>
<p><strong>Add a resistor to ground to represent the input impedance at the end
of the waveguide.</strong> In the <span class="guilabel">Add Part</span> dialog, choose
<span class="menuselection">Resistors ‣ One Port Resistor to Ground</span>. Place this
item on the schematic.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_9.png"><img alt="../../../_images/transient_sim_9.png" src="../../../_images/transient_sim_9.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_10.png"><img alt="../../../_images/transient_sim_10.png" src="../../../_images/transient_sim_10.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_11.png"><img alt="../../../_images/transient_sim_11.png" src="../../../_images/transient_sim_11.png" style="width: 30%;" /></a>
<p><strong>Wire the circuit.</strong>
Right click on the schematic, choose <span class="guilabel">Add Wire</span>,
connect the components following this order: pulse generator, series
resistor, DUT Port 1, DUT Port 2, resistor to ground.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_12.png"><img alt="../../../_images/transient_sim_12.png" src="../../../_images/transient_sim_12.png" style="width: 30%;" /></a>
<p><strong>Add an input probe.</strong> In the <span class="guilabel">Add Part</span> window, choose
<span class="menuselection">Ports and Probes ‣ Output</span>. Place this probe on
the wire after the series resistor at the DUT Port 1.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_13.png"><img alt="../../../_images/transient_sim_13.png" src="../../../_images/transient_sim_13.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_14.png"><img alt="../../../_images/transient_sim_14.png" src="../../../_images/transient_sim_14.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_15.png"><img alt="../../../_images/transient_sim_15.png" src="../../../_images/transient_sim_15.png" style="width: 30%;" /></a>
<p><strong>Add an output probe.</strong> Repeat the above step, add another probe on top
(in parallel) of the resistor to ground, at the DUT Port 2.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_13.png"><img alt="../../../_images/transient_sim_13.png" src="../../../_images/transient_sim_13.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_16.png"><img alt="../../../_images/transient_sim_16.png" src="../../../_images/transient_sim_16.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_17.png"><img alt="../../../_images/transient_sim_17.png" src="../../../_images/transient_sim_17.png" style="width: 30%;" /></a>
<p><strong>Run simulation.</strong> Click <span class="guilabel">Calculate</span> on the menu bar, and choose
<span class="guilabel">Simulate</span>. After simulation finishes, it opens a time-domain
line chart. After pressing the “Zoom” (magnifying glass) button and
dragging a rectangle on a part of the waveform of interest, one can finally
see the pulse response of the DUT.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_18.png"><img alt="../../../_images/transient_sim_18.png" src="../../../_images/transient_sim_18.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/transient_sim_19.png"><img alt="../../../_images/transient_sim_19.png" src="../../../_images/transient_sim_19.png" style="width: 30%;" /></a>
<p><strong>Results.</strong> As expected, the +/- 1 V input signal (+/- 0.5 V with 50 Ω
output and input impedance) has severe overshoots and undershoots due to
port impedance mismatches, while the output shows significant rise
time degradation due to high insertios loss above 2 GHz.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_20.png"><img alt="../../../_images/transient_sim_20.png" src="../../../_images/transient_sim_20.png" style="width: 60%;" /></a>
</section>
<section id="eye-diagram-analysis">
<h4>Eye Diagram Analysis<a class="headerlink" href="#eye-diagram-analysis" title="Permalink to this headline"></a></h4>
<p>For the next example, let’s examine the circuit’s time-domain signal
integrity using a Pseudo-Random Bit Stream (PRBS) generator as the
input, and to plot its output on an eye diagram.</p>
<p><strong>Delete the voltage pulse generator.</strong> Right-click the voltage
pulse generator we added previously, select <span class="guilabel">delete</span>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Don’t select <span class="guilabel">convert</span>, it seems buggy and would prevent
the generation of eye diagram after simulation.</p>
</div>
<a class="reference internal image-reference" href="../../../_images/eye_sim_1.png"><img alt="../../../_images/eye_sim_1.png" src="../../../_images/eye_sim_1.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/eye_sim_2.png"><img alt="../../../_images/eye_sim_2.png" src="../../../_images/eye_sim_2.png" style="width: 30%;" /></a>
<p><strong>Add a Pseudo-Random Bitstream Generator (PSBG).</strong> In the
<span class="guilabel">Add Part</span> dialog, choose
<span class="menuselection">Generators ‣ One-Port Voltage PRBS</span>. Change its
<span class="guilabel">risetime (s)</span> to “100 ps”. Place this item on the schematic.</p>
<a class="reference internal image-reference" href="../../../_images/eye_sim_3.png"><img alt="../../../_images/eye_sim_3.png" src="../../../_images/eye_sim_3.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/eye_sim_4.png"><img alt="../../../_images/eye_sim_4.png" src="../../../_images/eye_sim_4.png" style="width: 30%;" /></a>
<p><strong>Add an eye probe.</strong> In the <span class="guilabel">Add Part</span> dialog, choose
<span class="menuselection">Ports and Probes ‣ EyeProbe</span>. Click <span class="guilabel">Eye
Diagram Configuration</span>. Set <span class="guilabel">Measure Eye Parameters</span> to
<code class="docutils literal notranslate"><span class="pre">True</span></code>, and change the ::guilabel::<cite>Color</cite> to yellow (255, 255, 0)
to improve diagram readability. By default, the eye diagram is
black-and-white. Then close this window.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Press <kbd class="kbd docutils literal notranslate">Enter</kbd> to apply changed R, G, or B values. It’s
<em>not</em> necessary to click <span class="guilabel">Save Properties to Global
Preferences</span>, by default these options are already applied
to a single schematic.</p>
</div>
<a class="reference internal image-reference" href="../../../_images/eye_sim_5.png"><img alt="../../../_images/eye_sim_5.png" src="../../../_images/eye_sim_5.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/eye_sim_6.png"><img alt="../../../_images/eye_sim_6.png" src="../../../_images/eye_sim_6.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/eye_sim_7.png"><img alt="../../../_images/eye_sim_7.png" src="../../../_images/eye_sim_7.png" style="width: 30%;" /></a>
<p><strong>Place the probe and wire the circuit.</strong> Place the eye probe on
the schematic. Wire the eye probe to DUT’s Port 2.</p>
<a class="reference internal image-reference" href="../../../_images/eye_sim_8.png"><img alt="../../../_images/eye_sim_8.png" src="../../../_images/eye_sim_8.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/eye_sim_9.png"><img alt="../../../_images/eye_sim_9.png" src="../../../_images/eye_sim_9.png" style="width: 30%;" /></a>
<p><strong>Run simulation.</strong> Click <span class="guilabel">Calculate</span> on the menu, choose
<span class="guilabel">Simulate</span>. After simulation finishes, it opens two plots,
an eye diagram plot and a time-domain line chart.</p>
<a class="reference internal image-reference" href="../../../_images/transient_sim_18.png"><img alt="../../../_images/transient_sim_18.png" src="../../../_images/transient_sim_18.png" style="width: 30%;" /></a>
<p><strong>Results.</strong> The eye diagram clearly shows our parallel-plate waveguide
has an extremely poor signal integrity. We will discuss the significance
of this result at the end of this tutorial.</p>
<a class="reference internal image-reference" href="../../../_images/eye_sim_10.png"><img alt="../../../_images/eye_sim_10.png" src="../../../_images/eye_sim_10.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/eye_sim_11.png"><img alt="../../../_images/eye_sim_11.png" src="../../../_images/eye_sim_11.png" style="width: 30%;" /></a>
<p><strong>Zoom in.</strong> The time-domain line chart can be zoomed by pressing the
“Magnifying Glass” button and drag a rectangle on a part of the waveform
of interest.  One can see that the overshoots, undershoots and
rise-time degradation is similar to the previous impulse signal
analysis.</p>
</section>
</section>
<section id="s-parameters-analysis-via-qucs">
<h3>S-Parameters Analysis via Qucs<a class="headerlink" href="#s-parameters-analysis-via-qucs" title="Permalink to this headline"></a></h3>
<p>Qucs is a free and open source circuit simulator for RF/microwave
engineering, it’s capable of simulating circuits in both time and
frequency domains.</p>
<section id="id9">
<h4>Install<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h4>
<p>Qucs has a somewhat confusing development history, three different
spinoffs exist.</p>
<ol class="arabic simple">
<li><p><strong class="program">Qucs</strong>. Development of the original <strong class="program">Qucs</strong> started
in the early 2000s, but was slowed down over time. Finally in ~2019,
its underlying GUI framework Qt4 has been discontinued, making it
uninstallable on most operating systems. Its <strong class="program">Qucsator`</strong> engine
has good RF simulation features, but limited time-domain capabilities
with performance and convergence issues.</p></li>
<li><p><strong class="program">QucsStudio</strong> is a free-of-charge spinoff of Qucs with
additional features, but it’s <strong>not</strong> free and open source software.</p></li>
<li><p><strong class="program">Qucs-S</strong>. The project <strong class="program">Qucs-S</strong> is a fork of
<strong class="program">Qucs</strong> with a modernized codebase, aiming to support
multiple SPICE backends for improved time-domain simulations,
such as <cite>Ngspice</cite>. RF simulations still use the original
<strong class="program">Qucsator</strong> engine externally before Qucs-S 24.2.0
(meaning that an installation of the now-unavailable Qucs is
still needed). After Qucs-S 24.2.0, <strong class="program">Qucsator</strong> is
now a builtin option.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For this tutorial, we use Qucs-S 25.1.0. Other Qucs spinoffs
or older Qucs-S versions have features and user interface
changes that are in conflict with this tutorial, so one should
use Qucs-S 25.1.0 or newer when following this tutorial.</p>
</div>
<p>The Qucs-S packages in most operating systems are outdated, thus,
Debian, Ubuntu, Fedora and openSUSE users should use the third-party
maintained by Qucs-S projcet developers. It’s hosted on Open Build
Service (OBS), installation instructions can be found in the following
link.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://software.opensuse.org/download.html?project=home%3Ara3xdh&amp;package=qucs-s">https://software.opensuse.org/download.html?project=home%3Ara3xdh&amp;package=qucs-s</a></p></li>
</ul>
<p>Alternatively, if no package is available, a self-contained AppImage
version is also available as a stop-gap measure before it’s packaged.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ra3xdh/qucs_s/releases/tag/25.1.0">https://github.com/ra3xdh/qucs_s/releases/tag/25.1.0</a></p></li>
</ul>
<p>Download <code class="docutils literal notranslate"><span class="pre">Qucs-S-25.1.0-linux-x86_64.AppImage</span></code>, and grant it
execution permission:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">Qucs</span><span class="o">-</span><span class="n">S</span><span class="o">-</span><span class="mf">25.1.0</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">AppImage</span>
</pre></div>
</div>
</section>
<section id="enable-qucsator">
<span id="qucsator"></span><h4>Enable Qucsator<a class="headerlink" href="#enable-qucsator" title="Permalink to this headline"></a></h4>
<p>As previously mentioned, Qucs-S uses Ngspice for simulation by default,
but it lacks some features required for RF/microwave applications that
we need. Hence, we must switch Qucs-S’s engine from Ngspice to Qucsator.</p>
<p><strong>Switch the engine.</strong> Press the drop-down list at the top-right of
the Qucs-S window. By default, it should show <cite>Ngspice</cite>, click
it and change it to <cite>Qucsator</cite>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-1.png"><img alt="../../../_images/qucs-engine-1.png" src="../../../_images/qucs-engine-1.png" style="width: 30%;" /></a>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If the option <span class="guilabel">Qucsator</span> does not exist (it usually
disappears when one quits and restarts the application), it
means you’re affected by a bug in the AppImage version of
Qucs-S. See <a class="reference internal" href="#qucsator-bug"><span class="std std-ref">No Qucsator in Qucs-S</span></a> for the solution.</p>
</div>
</section>
<section id="s-parameter-simulation-skeleton">
<h4>S-Parameter Simulation Skeleton<a class="headerlink" href="#s-parameter-simulation-skeleton" title="Permalink to this headline"></a></h4>
<p>To perform frequency-domain analysis in Qucs (Qucs-S), we
need to add several components in multiple steps: adding two
power sources, entering two equations for calculating scalar
S-parameters <span class="math notranslate nohighlight">\(S_{11}\)</span> and <span class="math notranslate nohighlight">\(S_{21}\)</span>, adding an
“S-parameter simulation” block with parameters, and inserting
the DUT in the middle between the two ports.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><em>Before</em> a filter is synthesized, Qucs-S must be switched to
use Qucsator as its engine as described in <a class="reference internal" href="#qucsator"><span class="std std-ref">Enable Qucsator</span></a>.
Otherwise a broken schematic would be synthesized with non-functional
equations - S-parameter simulations won’t work correctly.</p>
</div>
<p><strong>Open the filter wizard.</strong> A trick allows us to quickly setting up a
skeleton - “borrowing” the setup generated by Qucs’s filter synthesis
wizard. Click <span class="menuselection">Tools ‣ Filter synthesis</span>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-1.png"><img alt="../../../_images/qucs-filter-1.png" src="../../../_images/qucs-filter-1.png" style="width: 60%;" /></a>
<p><strong>Synthesize a filter.</strong> In the opened dialog, generate the default
low-pass LC filter by pressing <span class="guilabel">Calculate and put into Clipboard</span>,
without changing any parameters.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-2.png"><img alt="../../../_images/qucs-filter-2.png" src="../../../_images/qucs-filter-2.png" style="width: 30%;" /></a>
<p><strong>Paste it into schematic</strong>. Do <em>not</em> close the filter dialog yet.
Now right-click the schematic, click <span class="guilabel">Paste</span>. Paste the
synthesized filter circuit onto the page by left-clicking. After
pasting, it’s free to close the filter dialog.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-3.png"><img alt="../../../_images/qucs-filter-3.png" src="../../../_images/qucs-filter-3.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-4.png"><img alt="../../../_images/qucs-filter-4.png" src="../../../_images/qucs-filter-4.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-5.png"><img alt="../../../_images/qucs-filter-5.png" src="../../../_images/qucs-filter-5.png" style="width: 30%;" /></a>
<p><strong>Save the schematic to disk.</strong> Press the <span class="guilabel">💾</span> (floppy
disk) button, and choose a path. This is required before starting a
simulation.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-6.png"><img alt="../../../_images/qucs-filter-6.png" src="../../../_images/qucs-filter-6.png" style="width: 30%;" /></a>
<p><strong>Run simulation.</strong> Select <span class="menuselection">Simulation ‣ Simulate</span>.
A dialog should pop up without warnings or errors.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-7.png"><img alt="../../../_images/qucs-filter-7.png" src="../../../_images/qucs-filter-7.png" style="width: 30%;" /></a>
<p><strong>Add a Cartesian plot.</strong> On the <span class="guilabel">Main Dock</span> on the left,
switch from <span class="guilabel">lumped components</span> to <span class="guilabel">diagrams</span>.
Click the <span class="guilabel">Cartesian</span> component.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-8.png"><img alt="../../../_images/qucs-filter-8.png" src="../../../_images/qucs-filter-8.png" style="width: 30%;" /></a>
<p><strong>Plot dbS11.</strong> Click the schematic to place the component. In
the dialog, double-click the scalar <code class="docutils literal notranslate"><span class="pre">dbS11</span></code> to add it into the
<span class="guilabel">Graph</span> item list, then press <span class="guilabel">OK</span>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The scalars <code class="docutils literal notranslate"><span class="pre">dBS11</span></code> and <code class="docutils literal notranslate"><span class="pre">dbS21</span></code> are not to be confused with the
complex S-parameters <code class="docutils literal notranslate"><span class="pre">S[1,1]</span></code> and <code class="docutils literal notranslate"><span class="pre">S[2,1]</span></code>. In particular, the
Smith chart won’t work with a scalar value.</p>
</div>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-9.png"><img alt="../../../_images/qucs-filter-9.png" src="../../../_images/qucs-filter-9.png" style="width: 30%;" /></a>
<p><strong>Plot dbS21</strong>. Repeat the same steps above, add another
<span class="guilabel">Cartesian</span> component to the schematic. Click the schematic to
place it. In the dialog, double-click the scalar <code class="docutils literal notranslate"><span class="pre">dBS21</span></code> (not the
complex <code class="docutils literal notranslate"><span class="pre">S[2,1]</span></code>) to add this array into the <span class="guilabel">Graph</span> item
list. Click <span class="guilabel">OK</span>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-10.png"><img alt="../../../_images/qucs-filter-10.png" src="../../../_images/qucs-filter-10.png" style="width: 30%;" /></a>
<p><strong>Add a Smith chart.</strong> Click the <span class="guilabel">Smith Chart</span> component on the
<span class="guilabel">Main Dock</span>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-11.png"><img alt="../../../_images/qucs-filter-11.png" src="../../../_images/qucs-filter-11.png" style="width: 30%;" /></a>
<p><strong>Plot S[1,1].</strong> Click the schematic to place the component. In the
dialog, double-click <code class="docutils literal notranslate"><span class="pre">S[1,1]</span></code> (not dBS11) to add this array into the
<span class="guilabel">Graph</span> item list. Click “OK”.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-12.png"><img alt="../../../_images/qucs-filter-12.png" src="../../../_images/qucs-filter-12.png" style="width: 30%;" /></a>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>All subsequent mouse clicks will keep adding components to the schematic.
To stop, press <kbd class="kbd docutils literal notranslate">Esc</kbd> or click the <span class="guilabel">Select</span> button (cursor
icon) on the menu bar.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-13.png"><img alt="../../../_images/qucs-filter-13.png" src="../../../_images/qucs-filter-13.png" style="width: 30%;" /></a>
</div>
<p><strong>Plotting.</strong> Now we have a fully-functional S-parameter simulation skeleton
with S-parameters on two line chart and a Smith chart.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-14.png"><img alt="../../../_images/qucs-filter-14.png" src="../../../_images/qucs-filter-14.png" style="width: 30%;" /></a>
<p><strong>Delete the text label.</strong> The next step is to delete the filter, leaving
only the simulation skeleton. First, select the text label <span class="guilabel">Bessel
low-pass filter 1 GHz cutoff, …</span> by left-clicking it and pressing the
<kbd class="kbd docutils literal notranslate">Delete</kbd> key on the keyboard (or by right-cilking it and pressing
the <span class="guilabel">Delete</span> option).  This text label would be useless and
misleading if it’s left here.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-15.png"><img alt="../../../_images/qucs-filter-15.png" src="../../../_images/qucs-filter-15.png" style="width: 30%;" /></a>
<p><strong>Delete the inductor, capacitors, and wire segments.</strong> Select the
inductor and delete it by pressing the <kbd class="kbd docutils literal notranslate">Delete</kbd> key on the keyboard.
Delete the capacitors using the same procedure.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-16.png"><img alt="../../../_images/qucs-filter-16.png" src="../../../_images/qucs-filter-16.png" style="width: 30%;" /></a>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>It’s difficult to delete a wire segment without highlighting the
entire wire.  If you have trouble selecting a segment, try dragging
the mouse to highlight a rectangle that contains only that segment.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-17.png"><img alt="../../../_images/qucs-filter-17.png" src="../../../_images/qucs-filter-17.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-18.png"><img alt="../../../_images/qucs-filter-18.png" src="../../../_images/qucs-filter-18.png" style="width: 30%;" /></a>
</div>
<p><strong>Clean Skeleton Obtained.</strong> After all useless components are wires have
been deleted, the simulation skeleton is clean to use.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-19.png"><img alt="../../../_images/qucs-filter-19.png" src="../../../_images/qucs-filter-19.png" style="width: 30%;" /></a>
</section>
<section id="two-port-s-parameter-analysis">
<h4>Two-Port S-Parameter Analysis<a class="headerlink" href="#two-port-s-parameter-analysis" title="Permalink to this headline"></a></h4>
<p><strong>Add an S-parameter-defined component.</strong> On the left <span class="guilabel">Main Dock</span>,
switch from <span class="guilabel">diagram</span> (or <span class="guilabel">lumped components</span>) to
<span class="guilabel">file components</span>. Click <span class="guilabel">2-port S-parameters</span>, place
it on the schematic.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-20.png"><img alt="../../../_images/qucs-filter-20.png" src="../../../_images/qucs-filter-20.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-21.png"><img alt="../../../_images/qucs-filter-21.png" src="../../../_images/qucs-filter-21.png" style="width: 30%;" /></a>
<p><strong>Wire component together.</strong> Click the <span class="guilabel">Wire</span> icon on the menu
bar. Connect the DUT’s Port 1 to the left, connect Port 2 to the right,
and wire the Reference Port downwards.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-22.png"><img alt="../../../_images/qucs-filter-22.png" src="../../../_images/qucs-filter-22.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-23.png"><img alt="../../../_images/qucs-filter-23.png" src="../../../_images/qucs-filter-23.png" style="width: 30%;" /></a>
<p><strong>Add a ground.</strong> Click <span class="guilabel">Ground Node</span> on the menu bar, add a
ground below wire to the reference port.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Don’t forget to press <kbd class="kbd docutils literal notranslate">Esc</kbd> to exit from insert mode, otherwise
every mouse click results in more <span class="guilabel">Ground Nodes</span> on the
schematic.</p>
</div>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-24.png"><img alt="../../../_images/qucs-filter-24.png" src="../../../_images/qucs-filter-24.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-25.png"><img alt="../../../_images/qucs-filter-25.png" src="../../../_images/qucs-filter-25.png" style="width: 30%;" /></a>
<p><strong>Set S-parameter path.</strong> Double click the file component <span class="guilabel">X1</span>.
In the opened dialog, press the <span class="guilabel">…</span> button to change the
path of the Touchstone file that backs this parameter-defined component.
Pick the Touchstone file created by the openEMS simulation. Also, uncheck
the <span class="guilabel">Show</span> option, since the file path is extremely long and
visually cluttering. Press <span class="guilabel">OK</span>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-26.png"><img alt="../../../_images/qucs-filter-26.png" src="../../../_images/qucs-filter-26.png" style="width: 30%;" /></a>
<p><strong>Move Component Text.</strong> One may also want to adjust the position of
the text label <span class="guilabel">X1</span> to be directly above the component box
(since the space occupied by the file path has gone) to improve readability.
This can be done by right-clicking the component, select <span class="guilabel">Move
Component Text</span>, then drag the text to a new position.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-27.png"><img alt="../../../_images/qucs-filter-27.png" src="../../../_images/qucs-filter-27.png" style="width: 30%;" /></a>
<p><strong>Run simulation</strong>. Select <span class="guilabel">Simulation</span> and click
<span class="guilabel">Simulate</span>. A dialog should pop up without warnings or errors.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-7.png"><img alt="../../../_images/qucs-filter-7.png" src="../../../_images/qucs-filter-7.png" style="width: 30%;" /></a>
<p><strong>Results</strong>. Now the S-parameters from our simulation should appear on
the Smith and line charts.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-28.png"><img alt="../../../_images/qucs-filter-28.png" src="../../../_images/qucs-filter-28.png" style="width: 30%;" /></a>
</section>
<section id="comparison-with-microstrip">
<h4>Comparison with Microstrip<a class="headerlink" href="#comparison-with-microstrip" title="Permalink to this headline"></a></h4>
<p>In the analysis of RF/microwave devices, We often need to compare the
behavior of different circuits. Using the microstrip as an example (as
the limiting case of a parallel-plate waveguide when the lower plate has
an infinite size), we perform a simple comparison here.</p>
<p><strong>Select and move the existing circuit.</strong> Drag the mouse and select the
entire circuit, move it upwards to free up some space. Press <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Control</kbd>-<kbd class="kbd docutils literal notranslate">C</kbd></kbd>
to copy this circuit, then press <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">Control</kbd>-<kbd class="kbd docutils literal notranslate">V</kbd></kbd> to paste a new instance
and place it below the original.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-1.png"><img alt="../../../_images/qucs-microstrip-1.png" src="../../../_images/qucs-microstrip-1.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-2.png"><img alt="../../../_images/qucs-microstrip-2.png" src="../../../_images/qucs-microstrip-2.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-3.png"><img alt="../../../_images/qucs-microstrip-3.png" src="../../../_images/qucs-microstrip-3.png" style="width: 30%;" /></a>
<p><strong>Delete the extra file-defined component</strong>. Delete X2 and its ground
connect.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-4.png"><img alt="../../../_images/qucs-microstrip-4.png" src="../../../_images/qucs-microstrip-4.png" style="width: 30%;" /></a>
<p><strong>Add a microstrip.</strong>  On the left <span class="guilabel">Main Dock</span>, switch to
<span class="guilabel">transmission lines</span>. Click <span class="guilabel">Microstrip Line</span>,
and place it between Port 3 and Port 4.
Change its <span class="guilabel">W</span> (width) and <span class="guilabel">L</span> to <code class="docutils literal notranslate"><span class="pre">100</span> <span class="pre">mm</span></code>. Apply the
numer change by pressing <kbd class="kbd docutils literal notranslate">Enter</kbd>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-5.png"><img alt="../../../_images/qucs-microstrip-5.png" src="../../../_images/qucs-microstrip-5.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-6.png"><img alt="../../../_images/qucs-microstrip-6.png" src="../../../_images/qucs-microstrip-6.png" style="width: 30%;" /></a>
<p><strong>Add a substrate that supports the microstrip.</strong> On the left
<span class="guilabel">Main Dock</span>, click <span class="guilabel">Substrate</span>, and place it
at the bottom of the schematic. Change parameter <span class="guilabel">er</span> to <code class="docutils literal notranslate"><span class="pre">1.001</span></code>
(don’t use <code class="docutils literal notranslate"><span class="pre">1.0</span></code>, the Qucs-S’s internal formula is singular here).
Change parameter <span class="guilabel">h</span> (height) to <code class="docutils literal notranslate"><span class="pre">16</span> <span class="pre">mm</span></code>.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-7.png"><img alt="../../../_images/qucs-microstrip-7.png" src="../../../_images/qucs-microstrip-7.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-8.png"><img alt="../../../_images/qucs-microstrip-8.png" src="../../../_images/qucs-microstrip-8.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-9.png"><img alt="../../../_images/qucs-microstrip-9.png" src="../../../_images/qucs-microstrip-9.png" style="width: 30%;" /></a>
<p><strong>Add new equations for scalar S33 and S43</strong>. Double-click the
<span class="guilabel">Equation</span> component.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-11.png"><img alt="../../../_images/qucs-microstrip-11.png" src="../../../_images/qucs-microstrip-11.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-10.png"><img alt="../../../_images/qucs-microstrip-10.png" src="../../../_images/qucs-microstrip-10.png" style="width: 30%;" /></a>
<p>Change its formulas to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dBS21</span> <span class="o">=</span> <span class="n">dB</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mf">2.1</span><span class="p">])</span>
<span class="n">dBS11</span> <span class="o">=</span> <span class="n">dB</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mf">1.1</span><span class="p">])</span>
<span class="n">dBS33</span> <span class="o">=</span> <span class="n">dB</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mf">3.3</span><span class="p">])</span>
<span class="n">dBS43</span> <span class="o">=</span> <span class="n">dB</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="mf">4.3</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Make sure <code class="docutils literal notranslate"><span class="pre">S[3,3]</span></code> and <code class="docutils literal notranslate"><span class="pre">S[4,3]</span></code> matches the actual port numbers
on the schematics. If ports have been repeatedly deleted and inserted
into the schematic, they could be renumbered. If so, change the
port numbers back to <code class="docutils literal notranslate"><span class="pre">3</span></code> and <code class="docutils literal notranslate"><span class="pre">4</span></code>:</p>
</div>
<p><strong>Run simulation.</strong> Select <span class="guilabel">Simulation</span> and click <span class="guilabel">Simulate</span>.
A dialog should pop up without warnings or errors.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-filter-7.png"><img alt="../../../_images/qucs-filter-7.png" src="../../../_images/qucs-filter-7.png" style="width: 30%;" /></a>
<p><strong>Plots.</strong> Double-click the original <span class="math notranslate nohighlight">\(S_{11}\)</span> chart, add
<span class="guilabel">dBS33</span> to the graph by double-clicking this item. Similarly,
do the same to add <span class="guilabel">dbS41</span> to the original <cite>S_{21}</cite> chart, and
finally add <span class="guilabel">S[3,3]</span> to the Smith chart.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-12.png"><img alt="../../../_images/qucs-microstrip-12.png" src="../../../_images/qucs-microstrip-12.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-13.png"><img alt="../../../_images/qucs-microstrip-13.png" src="../../../_images/qucs-microstrip-13.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-14.png"><img alt="../../../_images/qucs-microstrip-14.png" src="../../../_images/qucs-microstrip-14.png" style="width: 30%;" /></a>
<p><strong>Results.</strong> By setting this Qucs-S simulation, we can compare the frequency
response of a parallel-plate waveguide against a microstrip transmission line.
From the simulation result, we find that their behaviors are significantly
different. Both transmission lines have a resonance at 1.5 GHz, but their
similarity ends here. At high frequencies, this parallel-plate waveguide has
extremely high losses, while the microstrip transmission line is lossless.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-microstrip-15.png"><img alt="../../../_images/qucs-microstrip-15.png" src="../../../_images/qucs-microstrip-15.png" style="width: 60%;" /></a>
<p>We will discuss the significance of this result at the end of this tutorial.</p>
</section>
</section>
<section id="field-dumps-analysis-via-paraview">
<h3>Field Dumps Analysis via ParaView<a class="headerlink" href="#field-dumps-analysis-via-paraview" title="Permalink to this headline"></a></h3>
<p>ParaView is a visualization program commonly used in the High-Performance
Computing (HPC) and scientific computing world. One can install it using
the operating system’s package manager.</p>
<p>In openEMS, we rely on ParaView to visualize raw electromagnetic fields
created during the simulation. For troubleshooting malfunctioning simulations
or understanding the physical behavior of a structure, this is quite helpful
as one can identify the problematic region directly by visualization.</p>
<p>We continue our total current density visualization example, introduced
as an optional step in <a class="reference internal" href="#fielddump"><span class="std std-ref">Optional: Create A Field Dump Box</span></a>. If the simulation finishes with
field dump enabled, a series of <cite>vtr</cite> files (which is a type of the VTK
file format) is created under the simulation directory.</p>
<a class="reference internal image-reference" href="../../../_images/paraview-1.png"><img alt="../../../_images/paraview-1.png" src="../../../_images/paraview-1.png" style="width: 30%;" /></a>
<p><strong>Open ParaView.</strong> To visualize these results, open ParaView first.
Click <span class="menuselection">Files ‣ Open</span>. Navigate to the simulation
data directory, open the <cite>vtr</cite> file series.</p>
<a class="reference internal image-reference" href="../../../_images/paraview-2.png"><img alt="../../../_images/paraview-2.png" src="../../../_images/paraview-2.png" style="width: 30%;" /></a>
<p><strong>Apply cell/point array for visualization.</strong> Make sure <code class="docutils literal notranslate"><span class="pre">RotH-Field</span></code>
appears in the <span class="guilabel">Cell/Point Array</span> list on the bottom left
of the ParaView window, and is checked. Click <span class="guilabel">Apply</span>. By
default, the visualization shows an empty rectangle because the displayed
physical quantity is set to <span class="guilabel">Solid Color</span> without any data.
Click <span class="guilabel">Solid Color</span> and change it to <span class="guilabel">RotH-Field</span>.</p>
<a class="reference internal image-reference" href="../../../_images/paraview-3.png"><img alt="../../../_images/paraview-3.png" src="../../../_images/paraview-3.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/paraview-4.png"><img alt="../../../_images/paraview-4.png" src="../../../_images/paraview-4.png" style="width: 30%;" /></a>
<p><strong>Play animated visualization.</strong> Now it’s possible to see the
current density by clicking the <span class="guilabel">Play</span> button to see an
animated visualization of electromagnetic wave propagation.</p>
<a class="reference internal image-reference" href="../../../_images/paraview-5.png"><img alt="../../../_images/paraview-5.png" src="../../../_images/paraview-5.png" style="width: 30%;" /></a>
<p><strong>Rescale the color-grading.</strong> However, ParaView can still render
this field dump incorrectly due to a problem in color-grading. If
ParaView’s color-grading scale uses a small values for reference
(as the field at t = 0 is zero), all fields (or current) injected
by the excitation source in later timesteps can be rendered as a deep
red as the color saturates, making them indistinguishable. This
happens by default, as shown in the following diagram. We can
solve this problem by clicking <span class="guilabel">Rescale to Visible Data Range</span>.</p>
<a class="reference internal image-reference" href="../../../_images/paraview-6.png"><img alt="../../../_images/paraview-6.png" src="../../../_images/paraview-6.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/paraview-7.png"><img alt="../../../_images/paraview-7.png" src="../../../_images/paraview-7.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/paraview-8.png"><img alt="../../../_images/paraview-8.png" src="../../../_images/paraview-8.png" style="width: 30%;" /></a>
<p><strong>Color scale sensitivity to timestep.</strong> On the other hand, if large
values are used for references, the beginning of the visualization
works okay. But in later timesteps, colors will be very shallow and
difficult to see. Thus the color-grading scale is quite sensitive to
the timestep at which the <span class="guilabel">Rescale to Visible Data Range</span>
button is pressed. In additional to automatic adjustment, manual
adjustiment may be necessary.</p>
<p><strong>Result.</strong> In this simulation, we find that rescaling at timestep
9 obtains a satisfactory video below.</p>
<div  class="sphinx-contrib-video-container align-left"><video controls="True" preload="auto"><source src="../../../_images/curlH.webm" type="video/webm"></video></div><div class="admonition important">
<p class="admonition-title">Important</p>
<p>To correctly visualize the fields in ParaView, one must apply
the corresponding Cell/Point Array, select the variable that
represents the physical quantity, and Rescale the color-grading
to match the data range. Otherwise, an empty box or a solid
color appears on ParaView.</p>
<p>Also, 3D dump boxs are tricky to visualize. By default it’s
rendered as an empty box. It’s possible to render a 2D slice
of the data, or possibly a 3D vector field. But it’s beyond
the scope of this tutorial.</p>
</div>
</section>
</section>
<section id="experimental-validation-and-discussion">
<h2>Experimental Validation and Discussion<a class="headerlink" href="#experimental-validation-and-discussion" title="Permalink to this headline"></a></h2>
<section id="motivation">
<h3>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline"></a></h3>
<p>As shown in earlier sections using different methods, the presented
frequency response of this parallel-plate waveguide have anomalous
losses at high frequencies, around 20 dB at 8 GHz. This behavior
runs against our expectation for both lumped capacitors and transmission
lines, both are essentially lossless.</p>
<a class="reference internal image-reference" href="../../../_images/s21_db_sim_skrf.svg"><img alt="../../../_images/s21_db_sim_skrf.svg" src="../../../_images/s21_db_sim_skrf.svg" width="49%" /></a>
<p>Unusual results like this one may indicate a modeling mistake that
either causes unphysical behavior or the excitation of theoretical
but unrealistic physical effects. Alternatively, it may reveal actual
physics rarely discussed in circuit textbooks, so it can be “new” to
us.</p>
</section>
<section id="experiment">
<h3>Experiment<a class="headerlink" href="#experiment" title="Permalink to this headline"></a></h3>
<p>Thus, this result calls for a validation. To test the validity of
this simulation result empirically, the author of this tutorial performed
an experiment using a self-built parallel-plate waveguide test fixture,
made of two brass plates with a thickness of 0.5 mm. Two SMA coax
connectors are installed on both sides. Conveniently, these
special connectors have lengthened inner conductors (meant for
connections to air lines). The connectors are screwed onto the upper
plate, while their inner conductors touches the lower plate below.
The plates are held to position using Nylon screws at four corners,
with a spacing of 16 mm.</p>
<a class="reference internal image-reference" href="../../../_images/experiment-fixture.svg"><img alt="../../../_images/experiment-fixture.svg" src="../../../_images/experiment-fixture.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/experiment_waveguide_1.jpg"><img alt="../../../_images/experiment_waveguide_1.jpg" src="../../../_images/experiment_waveguide_1.jpg" style="width: 49%;" /></a>
<p>Air is the only dielectric of this parallel-plate waveguide, so this
test fixture’s frequency response is sensitive to all conductors and
insulators nearby. To minimize interference, plastic zip ties were used
to suspend the fixture in free air. Care was made to ensure the zip ties
to minimize their passing through the gap between plates.</p>
<p>Its frequency response is measured by a 2-port Vector Network Analyzer
(VNA) from 100 MHz to 4.4 GHz.</p>
<a class="reference internal image-reference" href="../../../_images/experiment_waveguide_2.jpg"><img alt="../../../_images/experiment_waveguide_2.jpg" src="../../../_images/experiment_waveguide_2.jpg" style="width: 49%;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This experiment was meant to be only a quick qualitative test, not an
exact quantitative test, so the VNA was <em>not</em> fully calibrated. SOLT
calibration was performed, but the Open, Short, Load, and Thru standards
were all assumed ideal, which introduces errors at high frequencies,
and may affect frequency response flatness across the spectrum as well.
But the <em>trend</em> remains largely unaffected.</p>
</div>
</section>
<section id="results">
<h3>Results<a class="headerlink" href="#results" title="Permalink to this headline"></a></h3>
<p>A Qucs-S simulation is used to visualize the S-parameters from both
simulation and experiment. This is done by setting a simulation with
two S-parameter-defined components, one from the simulation, and another
from measurement. The obtained result is the following.</p>
<a class="reference internal image-reference" href="../../../_images/experiment-qucs-1.png"><img alt="../../../_images/experiment-qucs-1.png" src="../../../_images/experiment-qucs-1.png" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="../../../_images/experiment-qucs-2.png"><img alt="../../../_images/experiment-qucs-2.png" src="../../../_images/experiment-qucs-2.png" style="width: 49%;" /></a>
<p>As we can see, both the <span class="math notranslate nohighlight">\(S_{11}\)</span> and <span class="math notranslate nohighlight">\(S_{21}\)</span> magnitudes
from the simulation and measurement are correlated, including the
resonance at 500 MHz, the resonance at 1.5 GHz, and the 20 dB loss
around 2 GHz. On the Smith chart, the <span class="math notranslate nohighlight">\(S_{11}\)</span> phases also
shows good correlations between from 100 MHz to 1.3 GHz.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>TODO: compare TDR responses.</p>
</div>
<p>Therefore, the observed high-frequency loss is a real effect of the
parallel-plate waveguide. What is its origin? We can make several educated
guesses:</p>
<ol class="arabic">
<li><p><strong>Non-TEM modes.</strong> Ordinary two-conductor transmission lines and
circuits operate in TEM (Transverse Electro-Magnetic) mode, in
which the directions of electric and magnetic fields are
orthogonal to the direction of wave propagation. But if the
operating frequency is sufficiently high, high-order waveguide
modes may be excited, resulted in multimoding. This often occurs
if the separation is large enough to allow the electric field
across the conductors to vary. This does not necessarily
increase the loss, but certainly is the source of confusing data.</p>
<p>The analytic solution of the TM01 or TE01 mode in a parallel-plate
waveguide is given by <span class="math notranslate nohighlight">\(\lambda = 2d / m\)</span>, <span class="math notranslate nohighlight">\(f_c =
v / \lambda\)</span>, in which <span class="math notranslate nohighlight">\(d\)</span> is the separation between the
plates, <span class="math notranslate nohighlight">\(m = 1, 2, 3...\)</span> is the waveguide mode index,
<span class="math notranslate nohighlight">\(v\)</span> is the speed of light in the medium, <span class="math notranslate nohighlight">\(\lambda\)</span> is
the cutoff wavelength, and <span class="math notranslate nohighlight">\(f_c\)</span> is the cutoff frequency. <a class="footnote-reference brackets" href="#id21" id="id10">9</a>
Using this calculation, we find that multimoding appears at 9.3 GHz
and above, so it indeed plays a small role.</p>
</li>
<li><p><strong>Radiation losses.</strong> Ordinary transmission lines are either fully
enclosed (like a rectangular waveguide) or has a tiny separation
distance to the ground plane much smaller than the wavelength.
But here, our plate separation is as large as 16 mm, which is
a significant portion of the signal wavelength, more than half at
10 GHz (30 mm). Radiation potentially escapes from this wavelength.</p></li>
<li><p><strong>Poor port termination.</strong> In ordinary transmission lines such
as microstrips, the line has a length much greater than its width, and
the width is comparable to the width of the port. The termination
resistance of the port also matches the characteristic impedance of
the line. Thus, the port perfectly absorbs the electromagnetic energy
with little secondary reflection. But in this demo, the port is both
physically and electrically mismatched on purpose. Thus it can’t
fully capture the energy of the incoming signal. These mismatches
can also exacerbate non-TEM modes and radiation losses near the
ports in many cases, not just those found in analytic solutions.</p></li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Nearly everything can be an RF waveguide or resonator
when the excitation frequency is high enough. For example,
the book <a class="footnote-reference brackets" href="#id22" id="id11">10</a> lists four possible high-order microstrip modes.
In fact, unrealistic excitation of high-order modes is fairly common
in E&amp;M field solvers as unphysical excitation signals or
port placements are easily created. Be sure to watch for it,
if the simulation results don’t seem to make sense.</p>
</div>
</section>
<section id="impedance-transformation">
<h3>Impedance Transformation<a class="headerlink" href="#impedance-transformation" title="Permalink to this headline"></a></h3>
<p>Another notable effect worth paying attention to is the resonance at 500
MHz and 1.5 GHz. Is it an intrinsic resonance caused by the waveguide itself,
or an artifact from the non-ideal ports?</p>
<a class="reference internal image-reference" href="../../../_images/s11_db_sim_skrf.svg"><img alt="../../../_images/s11_db_sim_skrf.svg" src="../../../_images/s11_db_sim_skrf.svg" width="49%" /></a>
<p>This can be revealed by a simple calculation. In vacuum or air, the wavelength
of an electromagnetic signal at 500 MHz is approximately 600 mm. At 1.5 GHz,
the wavelength is approximately 200 mm. Both are integer multiples of the
length of our parallel-plate waveguide, suggesting it’s an impedance
transformation.</p>
<p>In transmission line theory, a remarkable observation is the following:
if the length of a lossless transmission line is a multiple of
<span class="math notranslate nohighlight">\(\lambda / 2\)</span>, its input impedance is <em>exactly</em> equal to the load
impedance, regardless of its characteristic impedance!</p>
<p>The implication is that when a mismatched line with a length of
<span class="math notranslate nohighlight">\(\lambda / 2\)</span> is used to connect a transmitter and a receiver, if
both ports have real and identical impedances (i.e. they’re
mismatched the same way), <em>any</em> transmission line can be used
regardless of its characteristic impedance.</p>
<p>We can show this from a simple argument. Consider a 600 Ω transmission
line, connected to a 50 Ω receiver. If we measure its impedance using a
600 Ω transmitter at a fixed frequency, we would find its reflection
coefficient has a phase shift that changes depending on the length of
the line.</p>
<a class="reference internal image-reference" href="../../../_images/half-wave-1.svg"><img alt="A 50 Ω transmitter is connected to a 50 Ω receiver via a 600 Ω transmission line with a length of 0.2λ, its input reflection coefficient is 1.0∠3.1°, its input impedance is 1789.4∠74.1° Ω." src="../../../_images/half-wave-1.svg" width="49%" /></a>
<a class="reference internal image-reference" href="../../../_images/half-wave-2.svg"><img alt="A 50 Ω transmitter is connected to a 50 Ω receiver via a 600 Ω transmission line with a length of 0.4λ, its input reflection coefficient is 1.0∠-12.8°, its input impedance is 438.0∠-80.0° Ω." src="../../../_images/half-wave-2.svg" width="49%" /></a>
<p>But when the line is <span class="math notranslate nohighlight">\(\lambda / 2\)</span>, the phase
shift is zero, since the signal has shifted 180 degrees going forward,
and 180 degrees going back. As a result, the measured reflection
coefficient has a zero phase angle. Thus, the input impedance looking
into the beginning of the transmission line is exactly 600 Ω, without
an imaginary part.</p>
<a class="reference internal image-reference" href="../../../_images/half-wave-3.svg"><img alt="A 50 Ω transmitter is connected to a 50 Ω receiver via a 600 Ω transmission line with a length of 0.5λ, its input reflection coefficient is 0.0∠0.0°, its input impedance is 50.0∠0.0° Ω." src="../../../_images/half-wave-3.svg" width="49%" /></a>
<p>If we run the same 600 Ω transmission line using a 50 Ω transmitter
instead, we’d find that we still have a <em>perfect</em> impedance match,
since the overall input impedance of the transmission line is exactly
equal to the 50 Ω load.</p>
<p>Therefore, we can conclude the 500 MHz and 1500 MHz resonances are
effects of the mismatched ports resonating with the transmission line
due to its length, not the intrinsic characteristics of the parallel-plate
waveguide.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Quarter-Wave Impedance Transformer</strong> - This half-wave
transmission line is a special case of the powerful
quarter-wave impendance transformer. Learn more about
it at <a class="footnote-reference brackets" href="#id20" id="id12">8</a>.</p>
<p><strong>Port Discontinuities</strong> - This shows why an optimized
port transition, or the use of de-embedding or calibration
is crucial in both simulations and measurements. Otherwise
port mismatches can easily generate misleading results.</p>
</div>
</section>
</section>
<section id="troubleshoot">
<h2>Troubleshoot<a class="headerlink" href="#troubleshoot" title="Permalink to this headline"></a></h2>
<section id="notes-for-wayland-users">
<span id="wayland"></span><h3>Notes for Wayland Users<a class="headerlink" href="#notes-for-wayland-users" title="Permalink to this headline"></a></h3>
<p>Due to a technical limitation, Wayland desktop users may need to run
AppCSXCAD under X11 by unsetting the <code class="docutils literal notranslate"><span class="pre">WAYLAND_DISPLAY</span></code> environmental
variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ env WAYLAND_DISPLAY= AppCSXCAD Parallel_Plate_Capacitor.py.xml
</pre></div>
</div>
<p>Otherwise, significant performance degradation may be experienced
due to this repeating error on every draw: “GLEW could not be
initialized: Unknown Error.” The problem originated from the
internal implementations of GLEW and VTK, namely, GLEW attempts to
initialize X11 GLX when it’s compiled for X11 and Wayland at the same
time. The fix requires changing VTK, so openEMS has little control in
this matter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference external" href="https://github.com/thliebig/AppCSXCAD/issues/11">https://github.com/thliebig/AppCSXCAD/issues/11</a> for details.</p>
</div>
</section>
<section id="warning-unused-primitive-type-box-detected-in-property-plate">
<span id="unused-plate"></span><h3>Warning: Unused primitive (type: Box) detected in property: plate!<a class="headerlink" href="#warning-unused-primitive-type-box-detected-in-property-plate" title="Permalink to this headline"></a></h3>
<p>If you see the following warnings in the simulation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Create FDTD engine (compressed SSE + multi-threading)
Warning: Unused primitive (type: Box) detected in property: plate!
Warning: Unused primitive (type: Box) detected in property: plate!
Running FDTD engine... this may take a while... grab a cup of coffee?!?
[@        4s] Timestep:         1666 || Speed:   71.4 MC/s (2.401e-03 s/TS) || Energy: ~6.79e-22 (-68.99dB)
Time for 1666 iterations with 171500.00 cells : 4.00 sec
Speed: 71.42 MCells/s
</pre></div>
</div>
<p>It indicates the metal plates are not actually used in the simulation.</p>
<p>This is likely a meshing problem. All CSXCAD structure must pass at least a
single mesh line, including zero-thickness structures like thin metal plates.
Structures that stay in the middle of two mesh lines can’t be simulated.</p>
<p>To fix this problem, add mesh lines at the exact coordinate of zero-thickness
plates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># zero-thickness metal plates need mesh lines at their exact levels</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">AddLine</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A zero-thickness plate must cross or align exactly with at least one mesh
line, otherwise it can’t be simulated.</p>
</div>
</section>
<section id="warning-unused-primitive-type-box-detected-in-property-port-excite-1">
<span id="unused-excite"></span><h3>Warning: Unused primitive (type: Box) detected in property: port_excite_1!<a class="headerlink" href="#warning-unused-primitive-type-box-detected-in-property-port-excite-1" title="Permalink to this headline"></a></h3>
<p>If you see the following warnings in the simulation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Create FDTD engine (compressed SSE + multi-threading)
Warning: Unused primitive (type: Box) detected in property: port_excite_1!
Running FDTD engine... this may take a while... grab a cup of coffee?!?
[@        4s] Timestep:         1588 || Speed:   72.0 MC/s (2.519e-03 s/TS) || Energy: ~0.00e+00 (- 0.00dB)
[@        8s] Timestep:         3882 || Speed:  104.0 MC/s (1.744e-03 s/TS) || Energy: ~0.00e+00 (- 0.00dB)
</pre></div>
</div>
<p>It indicates the excitation port is not actually used in the simulation, this
is further confirmed by the energy of <code class="docutils literal notranslate"><span class="pre">~0.00e+00</span></code>: it means the port is disabled
so it didn’t inject any energy into the simulation box.</p>
<p>This is likely a meshing problem. All CSXCAD structure must pass at least a
single mesh line, including zero-thickness structures like the ports.
Structures that stay in the middle of two mesh lines can’t be simulated.</p>
<p>For example, because we used the 1/3-2/3 rule around the edges of the metal
plates, there’s no mesh line at the left and right edge of the metal plates.
Thus the following code won’t work:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span> <span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>As a compromise, we can shift the port’s location to the nearest mesh lines
along the X axis instead, this may introduce a small error as the port’s
measurement plane has shifted. But these issues is negligible for this demo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A port must cross or align exactly with at least one mesh line, otherwise
it can’t be simulated.</p>
</div>
<p>An alternative solution is to create a mesh line aligned with the port,
using the <code class="xref py py-meth docutils literal notranslate"><span class="pre">CSX.ContinuousStructure.AddLine()</span></code> function. This violates
the 1/3-2/3 rule, but is acceptable for long and narrow structures like
a transmission line with weak fringe fields on both ends.</p>
</section>
<section id="calcvoltageintegral-error-only-a-1d-line-integration-is-allowed">
<span id="voltage-integral-error"></span><h3>CalcVoltageIntegral: Error, only a 1D/line integration is allowed<a class="headerlink" href="#calcvoltageintegral-error-only-a-1d-line-integration-is-allowed" title="Permalink to this headline"></a></h3>
<p>If the openEMS output is flooded with the following error message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Engine_Interface_FDTD</span><span class="p">::</span><span class="n">CalcVoltageIntegral</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">only</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span><span class="o">/</span><span class="n">line</span> <span class="n">integration</span> <span class="ow">is</span> <span class="n">allowed</span>
<span class="n">Engine_Interface_FDTD</span><span class="p">::</span><span class="n">CalcVoltageIntegral</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">only</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span><span class="o">/</span><span class="n">line</span> <span class="n">integration</span> <span class="ow">is</span> <span class="n">allowed</span>
<span class="n">Engine_Interface_FDTD</span><span class="p">::</span><span class="n">CalcVoltageIntegral</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">only</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span><span class="o">/</span><span class="n">line</span> <span class="n">integration</span> <span class="ow">is</span> <span class="n">allowed</span>
<span class="n">Engine_Interface_FDTD</span><span class="p">::</span><span class="n">CalcVoltageIntegral</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">only</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span><span class="o">/</span><span class="n">line</span> <span class="n">integration</span> <span class="ow">is</span> <span class="n">allowed</span>
<span class="n">Engine_Interface_FDTD</span><span class="p">::</span><span class="n">CalcVoltageIntegral</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">only</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span><span class="o">/</span><span class="n">line</span> <span class="n">integration</span> <span class="ow">is</span> <span class="n">allowed</span>
<span class="n">Engine_Interface_FDTD</span><span class="p">::</span><span class="n">CalcVoltageIntegral</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">only</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span><span class="o">/</span><span class="n">line</span> <span class="n">integration</span> <span class="ow">is</span> <span class="n">allowed</span>
</pre></div>
</div>
<p>It means that openEMS is not able to calculate the voltage at a port
because the port is located at an ill-defined position. This happens
if the start and stop coordinates are different (i.e. not a 1D port),
but the size is smaller than a single mesh cell (i.e. when the port
is built from its start coordinate to its stop coordinate on each axis,
it does not overlap with at least two mesh lines).</p>
<p>For example, the following port is functional because it’s strictly
a 1D port, with identical start and stop coordinates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The following port is also functional because the 2D port passes
(overlaps with) at least two mesh lines when it’s built from Z = -8
to Z = 8:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The following port is also functional, because although there
is no mesh line at the stop position Z = 8.1, but the 2D port has
already crossed at least one mesh cell (two mesh lines) when it’s
built from Z = -8 to its stop coordinate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="mf">8.1</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="mf">8.1</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>But the following port is not functional, because the 2D port
does not cross a single mesh cell (two mesh lines) when it’s
built from Z = -8 to Z = -7.9. Although there’s a mesh line at Z = -8,
there is no mesh line between Z = -8 and Z = -7.9:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.9</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtd</span><span class="o">.</span><span class="n">AddLumpedPort</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="n">any_x</span><span class="p">,</span> <span class="n">any_y</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.9</span><span class="p">],</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">excite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>To fix the problem, either redefine the port with the correct
coordinates, or to add additional mesh lines.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>On each axis, a port must either be one-dimensional and aligned to a
mesh line, or two-dimensional and crosses (or overlaps) with two
mesh lines (a single mesh cell). Otherwise it can’t be simulated.</p>
<p>Furthermore, a port’s excitation direction must be two-dimensional.
If the port excites the Z direction, it must have a length on the Z axis,
satisfying the two constraints mentioned.</p>
</div>
</section>
<section id="no-qucsator-in-qucs-s">
<span id="qucsator-bug"></span><h3>No <span class="guilabel">Qucsator</span> in Qucs-S<a class="headerlink" href="#no-qucsator-in-qucs-s" title="Permalink to this headline"></a></h3>
<p>Unfortunately, the AppImage version of Qucs-S has a bug that prevents
Qucs-S from finding Qucsator. Each time an AppImage is launched, it’s
extracted to a random directory in <cite>/tmp</cite>, so Qucsator works exactly
once on each machine - after closing and relaunching it, the previously
configured <cite>Qucsator</cite> path would become invalid and can no longer
be found. Thus it disappears from the engine list.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-2.png"><img alt="../../../_images/qucs-engine-2.png" src="../../../_images/qucs-engine-2.png" style="width: 30%;" /></a>
<p>To work around this bug, the path to <cite>Qucsator</cite> must be configured
manually each time.</p>
<section id="programmatic-solution">
<h4>Programmatic Solution<a class="headerlink" href="#programmatic-solution" title="Permalink to this headline"></a></h4>
<p>We can solve this problem programmatically by clearing the <cite>Qucsator</cite>
variable setting from the Qucs-S configuration
file, usually located at <code class="docutils literal notranslate"><span class="pre">~/.config/qucs/qucs_s.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;/Qucsator=/d&#39;</span> <span class="o">~/.</span><span class="n">config</span><span class="o">/</span><span class="n">qucs</span><span class="o">/</span><span class="n">qucs_s</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>After quitting Qucs-S, running the command above, and restarting
Qucs-S, the <cite>Qucsator</cite> option should return to the engine list.</p>
</section>
<section id="gui-solution">
<h4>GUI Solution<a class="headerlink" href="#gui-solution" title="Permalink to this headline"></a></h4>
<p>For completeness, here’s how to do reconfige the path to Qucsator
manually. To do so, click <span class="guilabel">Simulation</span> and choose
<span class="guilabel">Simulators Settings…</span></p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-3.png"><img alt="../../../_images/qucs-engine-3.png" src="../../../_images/qucs-engine-3.png" style="width: 30%;" /></a>
<p>In the dialog, click <span class="guilabel">Select</span> under the <span class="guilabel">Qucsator
Settings</span> section.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-4.png"><img alt="../../../_images/qucs-engine-4.png" src="../../../_images/qucs-engine-4.png" style="width: 30%;" /></a>
<p>Navigate the file picker to <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>, right-click an empty area of the
file view, select <span class="guilabel">Show Hidden Files</span>. A directory with a suffix
named <code class="docutils literal notranslate"><span class="pre">/tmp/.mount_Qucs-</span></code> should appear, it has a random prefix that
varies every time it’s launched.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-5.png"><img alt="../../../_images/qucs-engine-5.png" src="../../../_images/qucs-engine-5.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-6.png"><img alt="../../../_images/qucs-engine-6.png" src="../../../_images/qucs-engine-6.png" style="width: 30%;" /></a>
<p>Enter this directory, enter directory <code class="docutils literal notranslate"><span class="pre">usr</span></code>, then enter <code class="docutils literal notranslate"><span class="pre">bin</span></code>, find
the executable named <code class="docutils literal notranslate"><span class="pre">qucsator_rf</span></code>. Select the executable and press
<span class="guilabel">Open</span> to pick it.  Finally, press <span class="guilabel">Apply changes</span>
in the <span class="guilabel">Setup simulators executable location</span> dialog.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-7.png"><img alt="../../../_images/qucs-engine-7.png" src="../../../_images/qucs-engine-7.png" style="width: 30%;" /></a>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-8.png"><img alt="../../../_images/qucs-engine-8.png" src="../../../_images/qucs-engine-8.png" style="width: 30%;" /></a>
<p>After doing so, the <span class="guilabel">Qucsator</span> option should reappear in
the engine drop-down list. Switch the engine from <span class="guilabel">Ngspice</span>
to <span class="guilabel">Qucsator</span> by clicking it.</p>
<a class="reference internal image-reference" href="../../../_images/qucs-engine-1.png"><img alt="../../../_images/qucs-engine-1.png" src="../../../_images/qucs-engine-1.png" style="width: 30%;" /></a>
</section>
</section>
</section>
<section id="bibliography">
<h2>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline"></a></h2>
<dl class="footnote brackets">
<dt class="label" id="id13"><span class="brackets"><a class="fn-backref" href="#id3">1</a></span></dt>
<dd><p>T. S. Bird, <a class="reference external" href="https://ieeexplore.ieee.org/document/5162049">“Definition and Misuse of Return Loss [Report of the
Transactions Editor-in-Chief],”</a>
in IEEE Antennas and Propagation Magazine, vol. 51, no. 2, pp. 166-167,
April 2009, doi: 10.1109/MAP.2009.5162049.</p>
</dd>
<dt class="label" id="id14"><span class="brackets"><a class="fn-backref" href="#id4">2</a></span></dt>
<dd><p>The Unknown Editor, <a class="reference external" href="https://www.microwaves101.com/encyclopedias/loss-or-gain">Microwaves101: Loss or Gain?</a></p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id5">3</a></span></dt>
<dd><p>The Unknown Editor, <a class="reference external" href="https://www.microwaves101.com/encyclopedias/snp-format">Microwaves101: SNP Format</a></p>
</dd>
<dt class="label" id="id16"><span class="brackets"><a class="fn-backref" href="#id6">4</a></span></dt>
<dd><p>Russell Carroll, <a class="reference external" href="https://emisleuth.com/Articles/How_to_Use_S-parameter_Models_in_PSpice_5-28-2024.pdf">How to Use S-parameter Models in PSpice</a></p>
</dd>
<dt class="label" id="id17"><span class="brackets"><a class="fn-backref" href="#id7">5</a></span></dt>
<dd><p>Giles Atkinson, <a class="reference external" href="https://sourceforge.net/p/ngspice/discussion/120973/thread/3bce0daf1c/#fffd">Reply to “How to perform transient simulation with S parameter file”</a></p>
</dd>
<dt class="label" id="id18"><span class="brackets"><a class="fn-backref" href="#id8">6</a></span></dt>
<dd><p>Peter J. Pupalaikis, <a class="reference external" href="https://www.cambridge.org/core/books/sparameters-for-signal-integrity/2FD44B994CD054E4B844B358E8903A09">S-parameters for Signal Integrity.</a>
Cambridge University Press, 2020.</p>
</dd>
<dt class="label" id="id19"><span class="brackets"><a class="fn-backref" href="#id2">7</a></span></dt>
<dd><p>Ted Yapo, <a class="reference external" href="https://cdn.hackaday.io/files/1656277086185568/gaussian_step_v11.pdf">A Note on Gaussian Steps in openEMS.</a></p>
</dd>
<dt class="label" id="id20"><span class="brackets"><a class="fn-backref" href="#id12">8</a></span></dt>
<dd><p>The Unknown Editor, <a class="reference external" href="https://www.microwaves101.com/encyclopedias/quarter-wave-tricks">Quarter-wave Tricks</a></p>
</dd>
<dt class="label" id="id21"><span class="brackets"><a class="fn-backref" href="#id10">9</a></span></dt>
<dd><p>Michael Steer. <a class="reference external" href="https://eng.libretexts.org/Bookshelves/Electrical_Engineering/Electronics/Microwave_and_RF_Design_II_-_Transmission_Lines_(Steer)/06%3A_Waveguides/6.03%3A_Parallel-Plate_Waveguide">Microwave and RF Design II - Transmission Lines,
6.3: Parallel-Plate Waveguide</a></p>
</dd>
<dt class="label" id="id22"><span class="brackets"><a class="fn-backref" href="#id11">10</a></span></dt>
<dd><p>Michael Steer. <a class="reference external" href="https://eng.libretexts.org/Bookshelves/Electrical_Engineering/Electronics/Microwave_and_RF_Design_II_-_Transmission_Lines_(Steer)/04%3A_Extraordinary_Transmission_Line_Effects/4.06%3A_Microstrip_Operating_Frequency_Limitations">Microwave and RF Design II - Transmission Lines,
4.6: Microstrip Operating Frequency Limitations</a></p>
</dd>
<dt class="label" id="id23"><span class="brackets"><a class="fn-backref" href="#id1">11</a></span></dt>
<dd><p>Andreas Rennings, Elektromagnetische Zeitbereichssimulationen innovativer
Antennen auf Basis von Metamaterialien. PhD Thesis, University of Duisburg-Essen,
2008, pp. 76, eq. 4.77</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="First_Lessons_Forewords.html" class="btn btn-neutral float-left" title="Start from the Basics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Intro_Tutorials.html" class="btn btn-neutral float-right" title="Introductional Tutorials" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Thorsten Liebig.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>